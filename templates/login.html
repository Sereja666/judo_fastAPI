<!-- templates/login.html -->
{% extends "base.html" %}

{% block title %}Вход в систему{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6 col-lg-5">
        <div class="card">
            <div class="card-header text-center">
                <h3 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i>Вход в систему</h3>
            </div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="phone" class="form-label">Телефон</label>
                        <input type="text" class="form-control" id="phone"
                               placeholder="Введите номер телефона" required>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">Пароль</label>
                        <input type="password" class="form-control" id="password"
                               placeholder="Введите пароль" required>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="loginBtn">
                            <i class="fas fa-sign-in-alt me-2"></i>Войти
                        </button>
                    </div>
                </form>

                <div class="mt-4 text-center">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Альтернативный способ входа:</strong><br>
                        Вы также можете войти через
                        <a href="{{ superset_url }}" class="alert-link">
                            Apache Superset
                        </a>
                    </div>

                    <div class="mt-3">
                        <a href="#" class="text-decoration-none" id="forgotPassword">
                            <i class="fas fa-key me-1"></i>Забыли пароль?
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Проверяем, есть ли уже токен
    const token = localStorage.getItem('access_token');
    if (token) {
        $.ajaxSetup({
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });

        // Если уже авторизован, перенаправляем на главную
        $.ajax({
            url: '/api/auth/me',
            method: 'GET',
            success: function(response) {
                if (response.authenticated) {
                    window.location.href = '/';
                }
            }
        });
    }

    $('#loginForm').on('submit', function(e) {
        e.preventDefault();

        const phone = $('#phone').val();
        const password = $('#password').val();

        // Показываем индикатор загрузки
        const loginBtn = $('#loginBtn');
        const originalText = loginBtn.html();
        loginBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Вход...');
        loginBtn.prop('disabled', true);

        // Отправляем запрос на сервер
        $.ajax({
            url: '/api/auth/login',  // Обратите внимание на префикс /api
            method: 'POST',
            contentType: 'application/x-www-form-urlencoded',
            data: {
                username: phone,
                password: password,
                grant_type: 'password'
            },
            success: function(response) {
                // Сохраняем токен в localStorage
                localStorage.setItem('access_token', response.access_token);
                localStorage.setItem('user', JSON.stringify(response.user));

                // Устанавливаем заголовок Authorization для будущих запросов
                $.ajaxSetup({
                    headers: {
                        'Authorization': 'Bearer ' + response.access_token
                    }
                });

                // Перенаправляем на главную страницу
                window.location.href = '/';
            },
            error: function(xhr) {
                alert('Ошибка входа: ' + (xhr.responseJSON?.detail || 'Неверные данные'));
                loginBtn.html(originalText);
                loginBtn.prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %}