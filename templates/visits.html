<!-- templates/visits.html -->
{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏—è–º–∏{% endblock %}

{% block content %}
<h1>üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å–µ—â–µ–Ω–∏—è–º–∏</h1>

<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">–í—ã–±–æ—Ä –¥–∞—Ç—ã –∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="visitDate" class="form-label">–î–∞—Ç–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ *</label>
                <select class="form-select" id="visitDate" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É --</option>
                    <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã JavaScript -->
                </select>
            </div>
            <div class="col-md-6 mb-3">
                <label for="trainerSelect" class="form-label">–¢—Ä–µ–Ω–µ—Ä *</label>
                <select class="form-select" id="trainerSelect" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞ --</option>
                    {% for trainer in trainers %}
                    <option value="{{ trainer.id }}">{{ trainer.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div id="schedulesSection" class="hidden">
            <h6 class="section-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</h6>
            <div id="schedulesList" class="row">
                <!-- –°–ø–∏—Å–æ–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>
</div>

<div id="studentsSection" class="card mt-4 hidden">
    <div class="card-header">
        <h5 class="mb-0">–£—á–µ–Ω–∏–∫–∏ –Ω–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>–ó–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏:</h6>
                <div id="scheduledStudentsList" class="mb-3">
                    <!-- –°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é -->
                </div>
            </div>
            <div class="col-md-6">
                <h6>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏:</h6>
                <div class="mb-3">
                    <label for="extraStudentSearch" class="form-label">–ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–∞:</label>
                    <input type="text" class="form-control" id="extraStudentSearch" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è">
                    <div class="form-text">–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–æ–≤ –Ω–µ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</div>
                </div>
                <div id="extraStudentsList">
                    <!-- –°–ø–∏—Å–æ–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤ -->
                </div>
            </div>
        </div>

        <div class="mt-3">
            <button type="button" class="btn btn-success btn-lg" onclick="saveVisits()">
                <i class="fas fa-save"></i>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Å–µ—â–µ–Ω–∏—è
            </button>
            <a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</a>
        </div>
    </div>
</div>

<div id="message" class="mt-3"></div>

<!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö -->
<input type="hidden" id="selectedScheduleId">
<input type="hidden" id="selectedVisitDate">
{% endblock %}

{% block scripts %}
<script>
    let selectedStudents = new Set();
    let extraStudents = new Set();
    let searchTimeout = null;

    $(document).ready(function() {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞—Ç—ã (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–Ω–µ–π)
        populateDates();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        $('#visitDate').change(function() {
            const selectedDate = $(this).val();
            if (selectedDate) {
                $('#selectedVisitDate').val(selectedDate);
                loadSchedulesForDate(selectedDate);
                $('#schedulesSection').removeClass('hidden');
            } else {
                $('#schedulesSection').addClass('hidden');
                $('#studentsSection').addClass('hidden');
            }
        });

        // –ü–æ–∏—Å–∫ —É—á–µ–Ω–∏–∫–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        $('#extraStudentSearch').on('input', function() {
            clearTimeout(searchTimeout);
            const query = $(this).val();

            if (query.length < 2) {
                $('#extraStudentsList').html('');
                return;
            }

            searchTimeout = setTimeout(() => {
                searchExtraStudents(query);
            }, 500);
        });
    });

    function populateDates() {
        const dateSelect = $('#visitDate');
        const today = new Date();

        for (let i = 0; i < 10; i++) {
            const date = new Date();
            date.setDate(today.getDate() - i);

            const dateString = date.toISOString().split('T')[0];
            const formattedDate = formatDate(date);

            const option = new Option(formattedDate, dateString);
            if (i === 0) {
                option.selected = true;
                $('#selectedVisitDate').val(dateString);
            }
            dateSelect.append(option);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
        loadSchedulesForDate($('#visitDate').val());
    }

    function formatDate(date) {
        const days = ['–í–°', '–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë'];
        const dayName = days[date.getDay()];
        return `${date.toLocaleDateString('ru-RU')} (${dayName})`;
    }

    function loadSchedulesForDate(date) {
        $('#schedulesList').html('<div class="col-12"><div class="text-center"><div class="spinner-border"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è...</p></div></div>');

        $.get(`/visits/get-schedules-by-date?date=${date}`)
            .done(function(schedules) {
                $('#schedulesList').empty();

                if (schedules.length === 0) {
                    $('#schedulesList').html('<div class="col-12"><div class="alert alert-info">–ù–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É –Ω–µ—Ç —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>');
                    $('#studentsSection').addClass('hidden');
                    return;
                }

                schedules.forEach(function(schedule) {
                    const scheduleElement = `
                        <div class="col-md-6 mb-3">
                            <div class="schedule-item" onclick="selectSchedule(${schedule.id})"
                                 data-schedule-id="${schedule.id}">
                                <h6>${schedule.time_start} - ${schedule.time_end}</h6>
                                <p class="mb-1"><strong>${schedule.sport_name}</strong></p>
                                <p class="mb-1">üìç ${schedule.place_name}</p>
                                ${schedule.description ? `<small class="text-muted">${schedule.description}</small>` : ''}
                            </div>
                        </div>
                    `;
                    $('#schedulesList').append(scheduleElement);
                });
            })
            .fail(function() {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è', 'danger');
            });
    }

    function selectSchedule(scheduleId) {
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
        $('.schedule-item').removeClass('selected');

        // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        $(`[data-schedule-id="${scheduleId}"]`).addClass('selected');

        $('#selectedScheduleId').val(scheduleId);

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        loadStudentsForSchedule(scheduleId);
        $('#studentsSection').removeClass('hidden');
    }

    function loadStudentsForSchedule(scheduleId) {
        $('#scheduledStudentsList').html('<div class="text-center"><div class="spinner-border spinner-border-sm"></div> –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤...</div>');

        $.get(`/visits/get-students-by-schedule?schedule_id=${scheduleId}`)
            .done(function(students) {
                $('#scheduledStudentsList').empty();

                if (students.length === 0) {
                    $('#scheduledStudentsList').html('<div class="alert alert-warning">–ù–∞ —ç—Ç—É —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É –Ω–µ—Ç –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤</div>');
                    return;
                }

                students.forEach(function(student) {
                    const studentElement = `
                        <div class="form-check mb-2">
                            <input class="form-check-input student-checkbox" type="checkbox"
                                   value="${student.id}" id="student_${student.id}"
                                   onchange="toggleStudent(${student.id}, this.checked, false)">
                            <label class="form-check-label" for="student_${student.id}">
                                ${student.name}
                                ${student.rang ? `<span class="badge bg-secondary">${student.rang}</span>` : ''}
                                ${student.weight ? `<small class="text-muted">(${student.weight}–∫–≥)</small>` : ''}
                            </label>
                        </div>
                    `;
                    $('#scheduledStudentsList').append(studentElement);
                });
            })
            .fail(function() {
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–µ–Ω–∏–∫–æ–≤', 'danger');
            });
    }

    function searchExtraStudents(query) {
        $.get(`/visits/search-students?query=${encodeURIComponent(query)}`)
            .done(function(students) {
                $('#extraStudentsList').empty();

                if (students.length === 0) {
                    $('#extraStudentsList').html('<div class="text-muted">–£—á–µ–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>');
                    return;
                }

                students.forEach(function(student) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —ç—Ç–æ—Ç —É—á–µ–Ω–∏–∫
                    const isAdded = extraStudents.has(student.id.toString());

                    const studentElement = `
                        <div class="form-check mb-2">
                            <input class="form-check-input extra-student-checkbox" type="checkbox"
                                   value="${student.id}" id="extra_student_${student.id}"
                                   ${isAdded ? 'checked' : ''}
                                   onchange="toggleStudent(${student.id}, this.checked, true)">
                            <label class="form-check-label" for="extra_student_${student.id}">
                                ${student.name}
                                ${isAdded ? '<span class="badge bg-success">–¥–æ–±–∞–≤–ª–µ–Ω</span>' : ''}
                            </label>
                        </div>
                    `;
                    $('#extraStudentsList').append(studentElement);
                });
            })
            .fail(function() {
                showMessage('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤', 'danger');
            });
    }

    function toggleStudent(studentId, isChecked, isExtra) {
        const studentIdStr = studentId.toString();

        if (isExtra) {
            if (isChecked) {
                extraStudents.add(studentIdStr);
            } else {
                extraStudents.delete(studentIdStr);
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            $(`#extra_student_${studentId}`).next('label').find('.badge').remove();
            if (isChecked) {
                $(`#extra_student_${studentId}`).next('label').append(' <span class="badge bg-success">–¥–æ–±–∞–≤–ª–µ–Ω</span>');
            }
        } else {
            if (isChecked) {
                selectedStudents.add(studentIdStr);
            } else {
                selectedStudents.delete(studentIdStr);
            }
        }
    }

    function saveVisits() {
        const visitDate = $('#selectedVisitDate').val();
        const scheduleId = $('#selectedScheduleId').val();
        const trainerId = $('#trainerSelect').val();

        if (!visitDate || !scheduleId || !trainerId) {
            showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'danger');
            return;
        }

        if (selectedStudents.size === 0 && extraStudents.size === 0) {
            showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('visit_date', visitDate + 'T12:00:00'); // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è
        formData.append('schedule_id', scheduleId);
        formData.append('trainer_id', trainerId);

        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        selectedStudents.forEach(studentId => {
            formData.append('student_ids', studentId);
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
        extraStudents.forEach(studentId => {
            formData.append('extra_student_ids', studentId);
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        const saveButton = $('#studentsSection').find('button.btn-success');
        const originalText = saveButton.html();
        saveButton.html('<i class="fas fa-spinner fa-spin"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...').prop('disabled', true);

        fetch('/visits/save-visits', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            showMessage(data.message, 'success');

            if (data.warnings) {
                data.warnings.forEach(warning => {
                    showMessage(warning, 'warning');
                });
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            selectedStudents.clear();
            extraStudents.clear();
            $('.student-checkbox, .extra-student-checkbox').prop('checked', false);
            $('.badge.bg-success').remove();

        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'danger');
        })
        .finally(() => {
            saveButton.html(originalText).prop('disabled', false);
        });
    }

    function showMessage(text, type) {
        $('#message').html(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);

        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }
</script>

<style>
.schedule-item {
    cursor: pointer;
    transition: all 0.3s ease;
}

.schedule-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.schedule-item.selected {
    border-color: var(--superset-primary);
    background: linear-gradient(135deg, #f0f9ff 0%, #e1f5fe 100%);
}

.hidden {
    display: none;
}

.badge {
    font-size: 0.7em;
}
</style>
{% endblock %}