<!-- templates/partials/edit_students/main_js.html -->
<script>
    $(document).ready(function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 –¥–ª—è –ø–æ–∏—Å–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤
        $('#studentSelect').select2({
            language: "ru",
            placeholder: "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è —É—á–µ–Ω–∏–∫–∞",
            allowClear: true
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
        $('#studentSelect').change(function() {
            const studentId = $(this).val();
            if (studentId) {
                loadStudentData(studentId);
                $('#studentCard').removeClass('hidden');
                $('#studentCard h3').text('–ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ–Ω–∏–∫–∞');
                $('#studentForm button[type="submit"]').html('<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
            } else {
                $('#studentCard').addClass('hidden');
            }
        });

        // –£–î–ê–õ–ò–¢–¨ –≠–¢–û–¢ –ë–õ–û–ö –ö–û–î–ê (–æ–Ω –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ student_form.js)
        // // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —É—á–µ–Ω–∏–∫–∞
        // $('#studentForm').submit(function(e) {
        //     e.preventDefault();
        //     updateStudent();
        // });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        $('#certificateModal').on('hidden.bs.modal', function () {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            $('#certificateForm')[0].reset();
            $('#cert_id').prop('disabled', false);
            $('#deleteCertificateBtn').addClass('hidden');
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è —Å–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–≥—Ä–∞–¥
        $('#awardModal').on('hidden.bs.modal', function () {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            $('#awardForm')[0].reset();
            $('#competition_id').prop('disabled', false);
            $('#deleteAwardBtn').addClass('hidden');
        });
    });

    // ================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –£–ß–ï–ù–ò–ö–ê ==================

    function loadStudentData(studentId) {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞ ID:', studentId);

        $.get(`/edit-students/get-student-data/${studentId}`, function(student) {
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞:', student);

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —É—á–µ–Ω–∏–∫–∞
            $('#studentId').val(student.id);
            $('#name').val(student.name || '');
            $('#birthday').val(student.birthday ? student.birthday.split('T')[0] : '');
            $('#sport_discipline').val(student.sport_discipline || '');
            $('#rang').val(student.rang || '');
            $('#sports_rank').val(student.sports_rank || '');
            $('#sex').val(student.sex || '');
            $('#weight').val(student.weight || '');
            $('#telephone').val(student.telephone || '');
            $('#head_trainer_id').val(student.head_trainer_id || '');
            $('#second_trainer_id').val(student.second_trainer_id || '');
            $('#price').val(student.price || '');
            $('#payment_day').val(student.payment_day || '');
            $('#classes_remaining').val(student.classes_remaining || '');
            $('#expected_payment_date').val(student.expected_payment_date ? student.expected_payment_date.split('T')[0] : '');
            $('#parent1').val(student.parent1 || '');
            $('#parent2').val(student.parent2 || '');
            $('#date_start').val(student.date_start ? student.date_start.replace('Z', '').substring(0, 16) : '');
            $('#telegram_id').val(student.telegram_id || '');
            $('#active').prop('checked', student.active !== false);

            console.log('rang (belt color ID):', student.rang);
            console.log('sports_rank:', student.sports_rank);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ
            if (student.price) {
                const selectedOption = $('#price').find(`option[value="${student.price}"]`);
                if (selectedOption.length) {
                    const priceAmount = selectedOption.data('price-amount');
                    const classesCount = selectedOption.data('classes-count');

                    let infoText = '';
                    if (priceAmount) {
                        infoText += `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceAmount} —Ä—É–±. `;
                    }
                    if (classesCount) {
                        infoText += `–ó–∞–Ω—è—Ç–∏–π –≤ —Ç–∞—Ä–∏—Ñ–µ: ${classesCount}`;
                    }

                    $('#priceInfo').text(infoText);
                }
            }
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–¥–∏—Ç–µ–ª–µ–π —É—á–µ–Ω–∏–∫–∞
            loadStudentParents(studentId);
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–ø—Ä–∞–≤–∫–∏ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            loadMedicalCertificates(studentId);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–≥—Ä–∞–¥—ã –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            loadAwards(studentId);

        }).fail(function(xhr, status, error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞: ' + error, 'danger');
        });
    }

    function loadStudentParents(studentId) {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ–π —É—á–µ–Ω–∏–∫–∞ ID:', studentId);

        $.get(`/edit-students/get-parents/${studentId}`, function(parents) {
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã —Ä–æ–¥–∏—Ç–µ–ª–∏ —É—á–µ–Ω–∏–∫–∞:', parents);

            const container = $('#parentsContainer');
            const placeholder = $('#parentsPlaceholder');

            if (parents && parents.length > 0) {
                placeholder.hide();

                let html = '<div class="list-group">';
                parents.forEach(parent => {
                    html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${parent.full_name || parent.telegram_username || '–†–æ–¥–∏—Ç–µ–ª—å'}</strong>
                            <br>
                            <small class="text-muted">
                                ${parent.phone ? 'üì± ' + parent.phone + ' ' : ''}
                                ${parent.email ? 'üìß ' + parent.email + ' ' : ''}
                                ${parent.telegram_username ? 'üë§ @' + parent.telegram_username : ''}
                            </small>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="removeParent(${parent.relation_id}, this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    `;
                });
                html += '</div>';

                container.html(html);
            } else {
                placeholder.show();
                container.html('<div class="text-muted" id="parentsPlaceholder">–£ –¥–∞–Ω–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ä–æ–¥–∏—Ç–µ–ª–µ–π</div>');
            }

        }).fail(function(xhr, status, error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–æ–¥–∏—Ç–µ–ª–µ–π:', error);
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ä–æ–¥–∏—Ç–µ–ª–µ–π', 'warning');
        });
    }


    function showMessage(text, type) {
        $('#message').html(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);

        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞
    $('#price').change(function() {
        const selectedOption = $(this).find('option:selected');
        const priceAmount = selectedOption.data('price-amount');
        const classesCount = selectedOption.data('classes-count');

        let infoText = '';
        if (priceAmount) {
            infoText += `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceAmount} —Ä—É–±. `;
        }
        if (classesCount) {
            infoText += `–ó–∞–Ω—è—Ç–∏–π –≤ —Ç–∞—Ä–∏—Ñ–µ: ${classesCount}`;
        }

        $('#priceInfo').text(infoText);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–∏–π –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
        if (classesCount && !$('#classes_remaining').val()) {
            $('#classes_remaining').val(classesCount);
        }
    });

    function createNewStudent() {
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ç–µ–∫—É—â–µ–≥–æ —É—á–µ–Ω–∏–∫–∞
        $('#studentCard').addClass('hidden');

        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        $('#studentForm')[0].reset();

        // –£–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –∏–∑ select
        $('#studentSelect').val('').trigger('change');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ –ø–æ–ª–µ "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫"
        const now = new Date();
        const localDateTime = now.toISOString().slice(0, 16);
        $('#date_start').val(localDateTime);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å (–≥–∞–ª–æ—á–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞)
        $('#active').prop('checked', true);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
        $('#studentId').val('new');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –ø—É—Å—Ç–æ–π —Ñ–æ—Ä–º–æ–π
        $('#studentCard').removeClass('hidden');

        // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        $('#studentCard h3').text('–ù–æ–≤—ã–π —É—á–µ–Ω–∏–∫');

        // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        $('#studentForm button[type="submit"]').html('<i class="fas fa-user-plus"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É');

        // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø—Ä–∞–≤–∫–∏ –∏ –Ω–∞–≥—Ä–∞–¥—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
        $('#certificatesContainer').html('<div class="text-muted">–°–ø—Ä–∞–≤–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞</div>');
        $('#awardsContainer').html('<div class="text-muted">–ù–∞–≥—Ä–∞–¥—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞</div>');

        showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞', 'info');
    }

</script>