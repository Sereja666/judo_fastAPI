<!-- templates/partials/competitions/scripts/calendar.html -->
<script>
    function generateCalendar(year, month) {
        const calendar = $('#calendar');
        calendar.empty();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let firstDayOfWeek = firstDay.getDay();
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        const daysInMonth = lastDay.getDate();
        let date = 1;

        for (let i = 0; i < 6; i++) {
            if (date > daysInMonth) break;

            const weekRow = $('<div class="row week-row g-1"></div>');

            for (let j = 0; j < 7; j++) {
                const dayCell = $('<div class="col day-cell"></div>');

                if (i === 0 && j < firstDayOfWeek) {
                    dayCell.addClass('empty text-center p-2');
                    dayCell.html('<div class="empty-day"></div>');
                    weekRow.append(dayCell);
                    continue;
                } else if (date > daysInMonth) {
                    dayCell.addClass('empty text-center p-2');
                    dayCell.html('<div class="empty-day"></div>');
                    weekRow.append(dayCell);
                    continue;
                }

                const currentDay = new Date(year, month, date);
                const dateString = formatDateForAPI(currentDay);
                const isToday = isSameDay(currentDay, new Date());
                const dayEvents = eventsByDate[dateString] || [];
                const hasEvents = dayEvents.length > 0;
                const eventsCount = dayEvents.length;

                let dayClass = 'btn-day';
                if (isToday) {
                    dayClass += ' today';
                }
                if (hasEvents) {
                    dayClass += ' has-events';
                }

                // Создаем содержимое плитки
                let dayContent = `
                    <div class="btn-day-content">
                        <div class="day-header-row">
                            <div class="day-number">${date}</div>
                `;

                if (eventsCount > 0) {
                    dayContent += `
                        <div class="events-counter">
                            <span class="badge bg-primary rounded-pill">${eventsCount}</span>
                        </div>
                    `;
                }

                dayContent += `
                        </div>
                        <div class="day-events">
                `;

                if (eventsCount > 0) {
                    for (let k = 0; k < Math.min(eventsCount, 2); k++) {
                        const event = dayEvents[k];
                        const eventIcon = eventsCount > 1 && k === 1 ? 'ellipsis-h' : 'trophy';
                        dayContent += `
                            <div class="event-preview" title="${event.name}">
                                <i class="fas fa-${eventIcon}"></i>
                                <span>${truncateText(event.name, 12)}</span>
                            </div>
                        `;
                    }

                    if (eventsCount > 2) {
                        dayContent += `
                            <div class="event-preview text-muted">
                                <i class="fas fa-plus"></i>
                                <span>еще ${eventsCount - 2}</span>
                            </div>
                        `;
                    }
                } else {
                    dayContent += `
                        <div class="no-events">
                            <i class="far fa-calendar-times"></i>
                            <span>Нет мероприятий</span>
                        </div>
                    `;
                }

                dayContent += `
                        </div>
                    </div>
                `;

                const dayButton = $(`
                    <button class="${dayClass}" data-date="${dateString}"
                            data-bs-toggle="tooltip" data-bs-html="true"
                            data-bs-title="Загрузка мероприятий..."
                            onmouseenter="loadDayEventsTooltip('${dateString}')">
                        ${dayContent}
                    </button>
                `);

                dayCell.append(dayButton);
                weekRow.append(dayCell);
                date++;
            }

            calendar.append(weekRow);
        }

        // Инициализируем тултипы
        initializeTooltips();
    }

    function initializeTooltips() {
        // Удаляем старые тултипы
        $('[data-bs-toggle="tooltip"]').tooltip('dispose');

        // Инициализируем новые
        $('[data-bs-toggle="tooltip"]').tooltip({
            trigger: 'hover',
            placement: 'top',
            delay: {show: 500, hide: 100},
            html: true,
            container: 'body'
        });
    }

    function loadDayEventsTooltip(dateString) {
        const dayEvents = eventsByDate[dateString] || [];
        if (dayEvents.length === 0) {
            updateDayTooltip(dateString, '<div class="small text-muted">Нет мероприятий</div>');
            return;
        }

        let tooltipContent = '<div class="calendar-tooltip" style="max-width: 250px; text-align: left;">';

        if (dayEvents.length === 1) {
            const event = dayEvents[0];
            tooltipContent += `
                <div class="mb-2">
                    <strong class="d-block mb-1">${event.name}</strong>
            `;
            if (event.address) {
                tooltipContent += `
                    <div class="text-muted small">
                        <i class="fas fa-map-marker-alt me-1"></i> ${event.address}
                    </div>
                `;
            }
            tooltipContent += '</div>';
        } else {
            tooltipContent += `<strong class="d-block mb-2">Мероприятия (${dayEvents.length}):</strong>`;
            dayEvents.forEach((event, index) => {
                tooltipContent += `
                    <div class="tooltip-event-item mb-2" style="border-left: 3px solid var(--superset-primary); padding-left: 8px;">
                        <div class="fw-medium">${index + 1}. ${truncateText(event.name, 25)}</div>
                `;
                if (event.address) {
                    tooltipContent += `
                        <div class="text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i> ${truncateText(event.address, 20)}
                        </div>
                    `;
                }
                tooltipContent += '</div>';
            });
        }

        tooltipContent += '</div>';
        updateDayTooltip(dateString, tooltipContent);
    }

    function updateDayTooltip(dateString, tooltipContent) {
        const dayButton = $(`button[data-date="${dateString}"]`);

        if (!tooltipContent || tooltipContent === '<div class="calendar-tooltip" style="max-width: 250px; text-align: left;"></div>') {
            dayButton.removeAttr('data-bs-toggle');
            dayButton.removeAttr('data-bs-title');
            dayButton.removeAttr('data-bs-html');

            const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
            if (tooltipInstance) {
                tooltipInstance.dispose();
            }
            return;
        }

        dayButton.attr('data-bs-title', tooltipContent);

        const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
        if (tooltipInstance) {
            tooltipInstance.setContent({'.tooltip-inner': tooltipContent});
        } else {
            new bootstrap.Tooltip(dayButton[0], {
                trigger: 'hover',
                placement: 'top',
                delay: {show: 500, hide: 100},
                html: true,
                container: 'body'
            });
        }
    }

    function updateMonthDisplay() {
        const monthNames = [
            'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];
        $('#currentMonth').text(`${monthNames[currentMonth]} ${currentYear}`);
    }

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    // Обработчик клика по дню
    $(document).on('click', '.btn-day', function() {
        const date = $(this).data('date');
        currentSelectedDate = date;
        openDayModal(date);
    });

    // Обработчик для отображения тултипов при загрузке
    $(document).ready(function() {
        // Даем время на загрузку событий
        setTimeout(() => {
            $('.btn-day').each(function() {
                const date = $(this).data('date');
                if (date) {
                    loadDayEventsTooltip(date);
                }
            });
        }, 1000);
    });
</script>