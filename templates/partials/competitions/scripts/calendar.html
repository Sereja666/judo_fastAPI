<!-- templates/partials/competitions/scripts/calendar.html -->
<script>
    function generateCalendar(year, month) {
        console.log('üîπ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è', year, month);

        const calendar = $('#calendar');
        calendar.empty();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let firstDayOfWeek = firstDay.getDay();
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        const daysInMonth = lastDay.getDate();
        let date = 1;

        // –ü—Ä–æ—Å—Ç–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –ø–ª–∏—Ç–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∏–ª–µ–π
        const testDay = `
            <div class="row week-row mb-2">
                <div class="col day-cell">
                    <button class="btn-day today" data-date="2024-12-01">
                        <div class="btn-day-content">
                            <div class="day-header-row">
                                <div class="day-number">1</div>
                                <div class="events-counter">
                                    <span class="badge">2</span>
                                </div>
                            </div>
                            <div class="day-events">
                                <div class="event-preview">
                                    <i class="fas fa-trophy"></i> –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ
                                </div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>
        `;

        calendar.append(testDay);
        console.log('‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ø–ª–∏—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
    }

    function initializeTooltips() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—É–ª—Ç–∏–ø—ã
        $('[data-bs-toggle="tooltip"]').tooltip('dispose');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ
        $('[data-bs-toggle="tooltip"]').tooltip({
            trigger: 'hover',
            placement: 'top',
            delay: {show: 500, hide: 100},
            html: true,
            container: 'body'
        });
    }

    function loadDayEventsTooltip(dateString) {
        const dayEvents = eventsByDate[dateString] || [];
        if (dayEvents.length === 0) {
            updateDayTooltip(dateString, '<div class="small text-muted">–ù–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>');
            return;
        }

        let tooltipContent = '<div class="calendar-tooltip" style="max-width: 250px; text-align: left;">';

        if (dayEvents.length === 1) {
            const event = dayEvents[0];
            tooltipContent += `
                <div class="mb-2">
                    <strong class="d-block mb-1">${event.name}</strong>
            `;
            if (event.address) {
                tooltipContent += `
                    <div class="text-muted small">
                        <i class="fas fa-map-marker-alt me-1"></i> ${event.address}
                    </div>
                `;
            }
            tooltipContent += '</div>';
        } else {
            tooltipContent += `<strong class="d-block mb-2">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (${dayEvents.length}):</strong>`;
            dayEvents.forEach((event, index) => {
                tooltipContent += `
                    <div class="tooltip-event-item mb-2" style="border-left: 3px solid var(--superset-primary); padding-left: 8px;">
                        <div class="fw-medium">${index + 1}. ${truncateText(event.name, 25)}</div>
                `;
                if (event.address) {
                    tooltipContent += `
                        <div class="text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i> ${truncateText(event.address, 20)}
                        </div>
                    `;
                }
                tooltipContent += '</div>';
            });
        }

        tooltipContent += '</div>';
        updateDayTooltip(dateString, tooltipContent);
    }

    function updateDayTooltip(dateString, tooltipContent) {
        const dayButton = $(`button[data-date="${dateString}"]`);

        if (!tooltipContent || tooltipContent === '<div class="calendar-tooltip" style="max-width: 250px; text-align: left;"></div>') {
            dayButton.removeAttr('data-bs-toggle');
            dayButton.removeAttr('data-bs-title');
            dayButton.removeAttr('data-bs-html');

            const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
            if (tooltipInstance) {
                tooltipInstance.dispose();
            }
            return;
        }

        dayButton.attr('data-bs-title', tooltipContent);

        const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
        if (tooltipInstance) {
            tooltipInstance.setContent({'.tooltip-inner': tooltipContent});
        } else {
            new bootstrap.Tooltip(dayButton[0], {
                trigger: 'hover',
                placement: 'top',
                delay: {show: 500, hide: 100},
                html: true,
                container: 'body'
            });
        }
    }

    function updateMonthDisplay() {
        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];
        $('#currentMonth').text(`${monthNames[currentMonth]} ${currentYear}`);
    }

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –¥–Ω—é
    $(document).on('click', '.btn-day', function() {
        const date = $(this).data('date');
        currentSelectedDate = date;
        openDayModal(date);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    $(document).ready(function() {
        // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Å–æ–±—ã—Ç–∏–π
        setTimeout(() => {
            $('.btn-day').each(function() {
                const date = $(this).data('date');
                if (date) {
                    loadDayEventsTooltip(date);
                }
            });
        }, 1000);
    });
</script>