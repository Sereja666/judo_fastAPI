<!-- templates/login.html -->
{% extends "base.html" %}

{% block title %}–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6 col-lg-5">
        <div class="card">
            <div class="card-header text-center">
                <h3 class="mb-0"><i class="fas fa-sign-in-alt me-2"></i>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            </div>
            <div class="card-body">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö -->
                <div id="errorAlert" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                </div>

                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ -->
                <div id="successAlert" class="alert alert-success d-none" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successMessage"></span>
                </div>

                <form id="loginForm">
                    <div class="mb-3">
                        <label for="phone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" class="form-control" id="phone"
                               placeholder="+79184508448 –∏–ª–∏ 89184508448"
                               required>
                        <small class="form-text text-muted">
                            –í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –≤ –ª—é–±–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <input type="password" class="form-control" id="password"
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg" id="loginBtn">
                            <i class="fas fa-sign-in-alt me-2"></i>–í–æ–π—Ç–∏
                        </button>
                    </div>
                </form>

                <div class="mt-4 text-center">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞:</strong><br>
                        –í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑
                        <a href="{{ superset_url }}" class="alert-link">
                            Apache Superset
                        </a>
                    </div>

                    <div class="mt-3">
                        <a href="/choose-login" class="text-decoration-none">
                            <i class="fas fa-arrow-left me-1"></i>–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É –≤—Ö–æ–¥–∞
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
$(document).ready(function() {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤—Å–µ—Ö –±—É–¥—É—â–∏—Ö AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
    function setAuthHeader(token) {
        $.ajaxSetup({
            headers: {
                'Authorization': 'Bearer ' + token
            }
        });
        console.log('‚úÖ Authorization header set for future requests');
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–æ–∫–µ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    const existingToken = localStorage.getItem('access_token');
    if (existingToken) {
        setAuthHeader(existingToken);

        // –ï—Å–ª–∏ —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é
        $.ajax({
            url: '/api/auth/me',
            method: 'GET',
            success: function(response) {
                if (response.authenticated) {
                    window.location.href = '/';
                }
            },
              setAuthCookie(response.access_token);
            error: function() {
                // –¢–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π - —É–¥–∞–ª—è–µ–º
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
            }
        });
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
      $('#loginForm').on('submit', function(e) {
        e.preventDefault();

        const phone = $('#phone').val().trim();
        const password = $('#password').val();

        if (!phone || !password) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loginBtn = $('#loginBtn');
        const originalText = loginBtn.html();
        loginBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>–í—Ö–æ–¥...');
        loginBtn.prop('disabled', true);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        $.ajax({
            url: '/api/auth/login',
            method: 'POST',
            contentType: 'application/x-www-form-urlencoded',
            data: {
                username: phone,
                password: password,
                grant_type: 'password'
            },
            success: function(response) {
                console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥:', response);

                // 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ localStorage
                localStorage.setItem('access_token', response.access_token);
                localStorage.setItem('user', JSON.stringify(response.user));

                // 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –í–°–ï–• –±—É–¥—É—â–∏—Ö AJAX –∑–∞–ø—Ä–æ—Å–æ–≤
                $.ajaxSetup({
                    headers: {
                        'Authorization': 'Bearer ' + response.access_token
                    }
                });

                // 3. –£–°–¢–ê–ù–ê–í–õ–ò–í–ê–ï–ú COOKIE –î–õ–Ø MIDDLEWARE - –í–û–¢ –¢–£–¢!
                const date = new Date();
                date.setTime(date.getTime() + (24 * 60 * 60 * 1000)); // 24 —á–∞—Å–∞
                const expires = "expires=" + date.toUTCString();
                document.cookie = `access_token=${response.access_token}; ${expires}; path=/; Secure; SameSite=Strict`;
                console.log('‚úÖ Auth cookie set');

                // 4. –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                $.ajax({
                    url: '/api/auth/me',
                    method: 'GET',
                    success: function(meResponse) {
                        console.log('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', meResponse);

                        if (meResponse.authenticated) {
                            // 5. –ü–ï–†–ï–ù–ê–ü–†–ê–í–õ–Ø–ï–ú –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                            console.log('üîÑ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –≥–ª–∞–≤–Ω—É—é...');
                            window.location.href = '/';
                        } else {
                            alert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                            loginBtn.html(originalText);
                            loginBtn.prop('disabled', false);
                        }
                    },
                    error: function() {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                        loginBtn.html(originalText);
                        loginBtn.prop('disabled', false);
                    }
                });
            },
            error: function(xhr) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', xhr.responseJSON);
                alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (xhr.responseJSON?.detail || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'));
                loginBtn.html(originalText);
                loginBtn.prop('disabled', false);
            }
        });
    });
});
</script>
{% endblock %}
{% endblock %}