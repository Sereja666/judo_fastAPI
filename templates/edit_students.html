<!-- templates/edit_students.html -->
{% extends "base.html" %}

{% block title %}Редактирование данных учеников{% endblock %}

{% block content %}
<h1>Редактирование данных учеников</h1>

<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Выбор ученика</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <label for="studentSelect" class="form-label">Выберите ученика:</label>
                <select id="studentSelect" class="form-select" required>
                    <option value="">-- Выберите ученика --</option>
                    {% for student in students %}
                    <option value="{{ student.id }}">{{ student.name }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">Начните вводить имя для поиска</div>
            </div>
            <div class="col-md-6">
                <div class="d-flex align-items-end h-100">
                    <button type="button" class="btn btn-success" onclick="createNewStudent()">
                        ＋ Создать нового ученика
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="studentCard" class="student-card hidden">
    <h3>Карточка ученика</h3>
    <form id="studentForm">
        <input type="hidden" id="studentId" name="student_id">

        <!-- Основная информация -->
        <div class="form-section">
            <h5 class="section-title">Основная информация</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">ФИО ученика *</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="birthday" class="form-label">Дата рождения</label>
                    <input type="date" class="form-control" id="birthday" name="birthday">
                </div>
                <div class="col-md-12 mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="active" name="active" checked>
                        <label class="form-check-label" for="active">
                            Активный ученик
                        </label>
                    </div>
                    <div class="form-text">Если снять галочку, ученик будет скрыт из списков</div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="sport_discipline" class="form-label">Дисциплина</label>
                    <select class="form-select" id="sport_discipline" name="sport_discipline">
                        <option value="">-- Выберите дисциплину --</option>
                        {% for sport in sports %}
                        <option value="{{ sport.id }}">{{ sport.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="rang" class="form-label">Разряд</label>
                    <input type="text" class="form-control" id="rang" name="rang">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="sex" class="form-label">Пол</label>
                    <select class="form-select" id="sex" name="sex">
                        <option value="">-- Выберите пол --</option>
                        <option value="М">Мужской</option>
                        <option value="Ж">Женский</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="weight" class="form-label">Вес (кг)</label>
                    <input type="number" class="form-control" id="weight" name="weight" min="0">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="telephone" class="form-label">Телефон</label>
                    <input type="tel" class="form-control" id="telephone" name="telephone">
                </div>
            </div>
        </div>

        <!-- Тренеры -->
        <div class="form-section">
            <h5 class="section-title">Тренеры</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="head_trainer_id" class="form-label">Главный тренер</label>
                    <select class="form-select" id="head_trainer_id" name="head_trainer_id">
                        <option value="">-- Выберите тренера --</option>
                        {% for trainer in trainers %}
                        <option value="{{ trainer.id }}">{{ trainer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="second_trainer_id" class="form-label">Второй тренер</label>
                    <select class="form-select" id="second_trainer_id" name="second_trainer_id">
                        <option value="">-- Выберите тренера --</option>
                        {% for trainer in trainers %}
                        <option value="{{ trainer.id }}">{{ trainer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Оплата -->
        <div class="form-section">
            <h5 class="section-title">Оплата и занятия</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="price" class="form-label">Тариф</label>
                    <select class="form-select" id="price" name="price">
                        <option value="">-- Выберите тариф --</option>
                        {% for price in prices %}
                        <option value="{{ price.id }}"
                                data-price-amount="{{ price.price }}"
                                data-classes-count="{{ price.classes_in_price or 0 }}">
                            {% if price.description %}
                                {{ price.description }} - {{ price.price }} руб.
                            {% else %}
                                Тариф {{ price.id }} - {{ price.price }} руб.
                            {% endif %}
                            {% if price.classes_in_price %}
                                ({{ price.classes_in_price }} занятий)
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text" id="priceInfo"></div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="payment_day" class="form-label">День оплаты</label>
                    <input type="number" class="form-control" id="payment_day" name="payment_day" min="1" max="31">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="classes_remaining" class="form-label">Осталось занятий</label>
                    <input type="number" class="form-control" id="classes_remaining" name="classes_remaining" min="0">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="expected_payment_date" class="form-label">Ожидаемая дата оплаты</label>
                    <input type="date" class="form-control" id="expected_payment_date" name="expected_payment_date">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="date_start" class="form-label">Дата начала тренировок</label>
                    <input type="datetime-local" class="form-control" id="date_start" name="date_start">
                </div>
            </div>
        </div>

        <!-- Медицинские справки -->
        <div class="form-section">
            <h5 class="section-title">Медицинские справки</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="reference1" class="form-label">Справка 1 (действует до)</label>
                    <input type="date" class="form-control" id="reference1" name="reference1">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="reference2" class="form-label">Справка 2 (действует до)</label>
                    <input type="date" class="form-control" id="reference2" name="reference2">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="reference3" class="form-label">Справка 3 (действует до)</label>
                    <input type="date" class="form-control" id="reference3" name="reference3">
                </div>
            </div>
        </div>

        <!-- Дополнительно -->
        <div class="form-section">
            <h5 class="section-title">Дополнительно</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="telegram_id" class="form-label">Telegram ID</label>
                    <input type="number" class="form-control" id="telegram_id" name="telegram_id">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="parent1" class="form-label">Родитель 1 ID</label>
                    <input type="number" class="form-control" id="parent1" name="parent1">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="parent2" class="form-label">Родитель 2 ID</label>
                    <input type="number" class="form-control" id="parent2" name="parent2">
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-success btn-lg">Сохранить изменения</button>
        <a href="/" class="btn btn-secondary">← Назад к расписанию</a>
    </form>
</div>

<div id="message" class="mt-3"></div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Инициализация Select2 для поиска учеников
        $('#studentSelect').select2({
            language: "ru",
            placeholder: "Начните вводить имя ученика",
            allowClear: true
        });

        // Загрузка данных ученика при выборе
        $('#studentSelect').change(function() {
            const studentId = $(this).val();
            if (studentId) {
                loadStudentData(studentId);
                $('#studentCard').removeClass('hidden');
                $('#studentCard h3').text('Карточка ученика');
                $('#studentForm button[type="submit"]').text('Сохранить изменения');
            } else {
                $('#studentCard').addClass('hidden');
            }
        });

        // Обработка отправки формы
        $('#studentForm').submit(function(e) {
            e.preventDefault();
            updateStudent();
        });
    });

    function loadStudentData(studentId) {
        $.get(`/get-student-data/${studentId}`, function(student) {
            // Заполняем форму данными ученика
            $('#studentId').val(student.id);
            $('#name').val(student.name || '');
            $('#birthday').val(student.birthday ? student.birthday.split('T')[0] : '');
            $('#sport_discipline').val(student.sport_discipline || '');
            $('#rang').val(student.rang || '');
            $('#sex').val(student.sex || '');
            $('#weight').val(student.weight || '');
            $('#telephone').val(student.telephone || '');
            $('#head_trainer_id').val(student.head_trainer_id || '');
            $('#second_trainer_id').val(student.second_trainer_id || '');
            $('#price').val(student.price || '');
            $('#payment_day').val(student.payment_day || '');
            $('#classes_remaining').val(student.classes_remaining || '');
            $('#expected_payment_date').val(student.expected_payment_date ? student.expected_payment_date.split('T')[0] : '');
            $('#reference1').val(student.reference1 ? student.reference1.split('T')[0] : '');
            $('#reference2').val(student.reference2 ? student.reference2.split('T')[0] : '');
            $('#reference3').val(student.reference3 ? student.reference3.split('T')[0] : '');
            $('#parent1').val(student.parent1 || '');
            $('#parent2').val(student.parent2 || '');
            $('#date_start').val(student.date_start ? student.date_start.replace('Z', '').substring(0, 16) : '');
            $('#telegram_id').val(student.telegram_id || '');
            $('#active').prop('checked', student.active !== false);

            // Обновляем информацию о выбранном тарифе
            if (student.price) {
                const selectedOption = $('#price').find(`option[value="${student.price}"]`);
                if (selectedOption.length) {
                    const priceAmount = selectedOption.data('price-amount');
                    const classesCount = selectedOption.data('classes-count');

                    let infoText = '';
                    if (priceAmount) {
                        infoText += `Стоимость: ${priceAmount} руб. `;
                    }
                    if (classesCount) {
                        infoText += `Занятий в тарифе: ${classesCount}`;
                    }

                    $('#priceInfo').text(infoText);
                }
            }
        }).fail(function() {
            showMessage('Ошибка загрузки данных ученика', 'danger');
        });
    }

    function updateStudent() {
        const formData = new FormData(document.getElementById('studentForm'));
        const studentId = $('#studentId').val();

        console.log('Отправка данных:', Object.fromEntries(formData));
        console.log('Student ID:', studentId);

        // Определяем URL и метод в зависимости от того, новый это ученик или существующий
        const url = studentId === 'new' ? '/create-student' : '/update-student';
        const method = 'POST';

        fetch(url, {
            method: method,
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            showMessage(data.message, 'success');

            if (studentId === 'new') {
                // После создания нового ученика
                $('#studentId').val(data.student_id); // Устанавливаем реальный ID
                $('#studentCard h3').text('Карточка ученика');
                $('#studentForm button[type="submit"]').text('Сохранить изменения');

                // Добавляем нового ученика в выпадающий список
                const newStudentName = $('#name').val();
                const newStudentId = data.student_id;
                $('#studentSelect').append(new Option(newStudentName, newStudentId));
                $('#studentSelect').val(newStudentId).trigger('change');
            } else {
                // Обновляем имя в выпадающем списке для существующего ученика
                const studentSelect = $('#studentSelect');
                const currentStudentId = $('#studentId').val();
                const currentStudentName = $('#name').val();
                studentSelect.find(`option[value="${currentStudentId}"]`).text(currentStudentName);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showMessage('Ошибка сохранения: ' + error.message, 'danger');
        });
    }

    function showMessage(text, type) {
        $('#message').html(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);

        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }

    // Обработчик изменения выбора тарифа
    $('#price').change(function() {
        const selectedOption = $(this).find('option:selected');
        const priceAmount = selectedOption.data('price-amount');
        const classesCount = selectedOption.data('classes-count');

        let infoText = '';
        if (priceAmount) {
            infoText += `Стоимость: ${priceAmount} руб. `;
        }
        if (classesCount) {
            infoText += `Занятий в тарифе: ${classesCount}`;
        }

        $('#priceInfo').text(infoText);

        // Автоматически заполняем количество занятий если поле пустое
        if (classesCount && !$('#classes_remaining').val()) {
            $('#classes_remaining').val(classesCount);
        }
    });

    function createNewStudent() {
        // Скрываем карточку текущего ученика
        $('#studentCard').addClass('hidden');

        // Очищаем форму
        $('#studentForm')[0].reset();

        // Убираем выбранного ученика из select
        $('#studentSelect').val('').trigger('change');

        // Устанавливаем текущую дату в поле "Дата начала тренировок"
        const now = new Date();
        const localDateTime = now.toISOString().slice(0, 16);
        $('#date_start').val(localDateTime);

        // Устанавливаем активный статус (галочка включена)
        $('#active').prop('checked', true);

        // Устанавливаем специальное значение для нового ученика
        $('#studentId').val('new');

        // Показываем карточку с пустой формой
        $('#studentCard').removeClass('hidden');

        // Меняем заголовок
        $('#studentCard h3').text('Новый ученик');

        // Меняем текст кнопки сохранения
        $('#studentForm button[type="submit"]').text('Создать ученика');

        showMessage('Заполните данные для нового ученика', 'info');
    }
</script>
{% endblock %}