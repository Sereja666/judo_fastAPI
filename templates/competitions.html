<!-- templates/competitions.html -->
{% extends "base.html" %}

{% block title %}Календарь мероприятий{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Календарь мероприятий</h1>
    <div>
        <button class="btn btn-outline-secondary" onclick="previousMonth()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <span id="currentMonth" class="mx-3 fw-bold fs-5"></span>
        <button class="btn btn-outline-secondary" onclick="nextMonth()">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>
            Календарь соревнований и мероприятий
        </h5>
    </div>
    <div class="card-body">
        <!-- Дни недели -->
        <div class="row weekdays-row mb-2">
            <div class="col day-header text-center">Пн</div>
            <div class="col day-header text-center">Вт</div>
            <div class="col day-header text-center">Ср</div>
            <div class="col day-header text-center">Чт</div>
            <div class="col day-header text-center">Пт</div>
            <div class="col day-header text-center">Сб</div>
            <div class="col day-header text-center">Вс</div>
        </div>

        <!-- Контейнер для календаря -->
        <div id="calendar" class="calendar-grid">
            <!-- Календарь будет генерироваться JavaScript -->
        </div>
    </div>
</div>

<!-- Модальное окно для мероприятий дня -->
<div class="modal fade" id="dayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayModalTitle">Мероприятия</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dayEventsList">
                    <!-- Список мероприятий будет здесь -->
                </div>
                <div id="noEvents" class="text-center py-4" style="display: none;">
                    <p class="text-muted">На этот день нет мероприятий</p>
                    <button class="btn btn-primary" onclick="createCompetition()">
                        <i class="fas fa-plus"></i> Создать мероприятие
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<div id="message" class="mt-3"></div>
{% endblock %}

{% block scripts %}
<script>
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();
    let eventsByDate = {}; // Храним мероприятия по датам
    let currentSelectedDate = null; // Текущая выбранная дата для модального окна

    $(document).ready(function() {
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        // Загружаем мероприятия после создания календаря
        loadEventsForMonth(currentYear, currentMonth + 1);
    });

    function generateCalendar(year, month) {
        const calendar = $('#calendar');
        calendar.empty();

        // Первый день месяца
        const firstDay = new Date(year, month, 1);
        // Последний день месяца
        const lastDay = new Date(year, month + 1, 0);

        // День недели первого дня (0 - воскресенье, 1 - понедельник и т.д.)
        let firstDayOfWeek = firstDay.getDay();
        // Преобразуем к нашему формату (понедельник - 0)
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        // Количество дней в месяце
        const daysInMonth = lastDay.getDate();

        let date = 1;

        // Создаем недели
        for (let i = 0; i < 6; i++) {
            if (date > daysInMonth) break;

            const weekRow = $('<div class="row week-row mb-2"></div>');

            // Дни недели
            for (let j = 0; j < 7; j++) {
                const dayCell = $('<div class="col day-cell text-center p-2"></div>');

                if (i === 0 && j < firstDayOfWeek) {
                    // Пустые ячейки перед первым днем месяца
                    dayCell.html('&nbsp;');
                } else if (date > daysInMonth) {
                    // Пустые ячейки после последнего дня месяца
                    dayCell.html('&nbsp;');
                } else {
                    const currentDay = new Date(year, month, date);
                    // Исправляем проблему с часовым поясом - используем UTC дату
                    const dateString = formatDateForAPI(currentDay);
                    const isToday = isSameDay(currentDay, new Date());
                    const dayEvents = eventsByDate[dateString] || [];
                    const hasEvents = dayEvents.length > 0;

                    let dayClass = 'btn-day';
                    if (isToday) {
                        dayClass += ' today';
                    }
                    if (hasEvents) {
                        dayClass += ' has-events';
                    }

                    // Создаем содержимое дня
                    let dayContent = `
                        <div class="day-number">${date}</div>
                    `;

                    // Добавляем мероприятия если они есть
                    if (hasEvents) {
                        // Берем только первое мероприятие для отображения в календаре
                        const firstEvent = dayEvents[0];
                        dayContent += `
                            <div class="events-indicator">
                                <i class="fas fa-trophy me-1"></i>
                            </div>
                            <div class="event-preview" title="${firstEvent.name}">
                                ${truncateText(firstEvent.name, 15)}
                            </div>
                        `;
                    } else {
                        dayContent += '<div class="events-indicator"></div>';
                    }

                    const dayButton = $(`
                        <button class="btn ${dayClass}" data-date="${dateString}">
                            ${dayContent}
                        </button>
                    `);

                    dayCell.append(dayButton);
                    date++;
                }

                weekRow.append(dayCell);
            }

            calendar.append(weekRow);
        }
    }

    // Функция для форматирования даты в правильный формат для API (без времени)
    function formatDateForAPI(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    function isSameDay(date1, date2) {
        return date1.getDate() === date2.getDate() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getFullYear() === date2.getFullYear();
    }

    function updateMonthDisplay() {
        const monthNames = [
            'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];
        $('#currentMonth').text(`${monthNames[currentMonth]} ${currentYear}`);
    }

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        // Загружаем мероприятия для нового месяца
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        // Загружаем мероприятия для нового месяца
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    function loadEventsForMonth(year, month) {
        $.get(`/competitions/get-events?year=${year}&month=${month}`, function(events) {
            // Сбрасываем хранилище мероприятий
            eventsByDate = {};

            // Группируем мероприятия по датам
            events.forEach(event => {
                if (event.date) {
                    // Используем ту же функцию форматирования даты
                    const eventDate = new Date(event.date);
                    const dateString = formatDateForAPI(eventDate);

                    if (!eventsByDate[dateString]) {
                        eventsByDate[dateString] = [];
                    }
                    eventsByDate[dateString].push(event);
                }
            });

            // Перерисовываем календарь с мероприятиями
            redrawCalendarWithEvents();

        }).fail(function(xhr, status, error) {
            showMessage('Ошибка загрузки мероприятий: ' + error, 'danger');
        });
    }

    // Функция для перерисовки календаря с мероприятиями
    function redrawCalendarWithEvents() {
        const calendar = $('#calendar');
        calendar.empty();

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);

        let firstDayOfWeek = firstDay.getDay();
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        const daysInMonth = lastDay.getDate();
        let date = 1;

        for (let i = 0; i < 6; i++) {
            if (date > daysInMonth) break;

            const weekRow = $('<div class="row week-row mb-2"></div>');

            for (let j = 0; j < 7; j++) {
                const dayCell = $('<div class="col day-cell text-center p-2"></div>');

                if (i === 0 && j < firstDayOfWeek) {
                    dayCell.html('&nbsp;');
                } else if (date > daysInMonth) {
                    dayCell.html('&nbsp;');
                } else {
                    const currentDay = new Date(currentYear, currentMonth, date);
                    const dateString = formatDateForAPI(currentDay);
                    const isToday = isSameDay(currentDay, new Date());
                    const dayEvents = eventsByDate[dateString] || [];
                    const hasEvents = dayEvents.length > 0;

                    let dayClass = 'btn-day';
                    if (isToday) {
                        dayClass += ' today';
                    }
                    if (hasEvents) {
                        dayClass += ' has-events';
                    }

                    let dayContent = `<div class="day-number">${date}</div>`;

                    if (hasEvents) {
                        const firstEvent = dayEvents[0];
                        dayContent += `
                            <div class="events-indicator">
                                <i class="fas fa-trophy me-1"></i>
                            </div>
                            <div class="event-preview" title="${firstEvent.name}">
                                ${truncateText(firstEvent.name, 15)}
                            </div>
                        `;
                    } else {
                        dayContent += '<div class="events-indicator"></div>';
                    }

                    const dayButton = $(`
                        <button class="btn ${dayClass}" data-date="${dateString}">
                            ${dayContent}
                        </button>
                    `);

                    dayCell.append(dayButton);
                    date++;
                }

                weekRow.append(dayCell);
            }

            calendar.append(weekRow);
        }
    }

    // Обработчик клика по дню
    $(document).on('click', '.btn-day', function() {
        const date = $(this).data('date');
        currentSelectedDate = date; // Сохраняем выбранную дату
        openDayModal(date);
    });

    function openDayModal(date) {
        const modalDate = new Date(date + 'T00:00:00'); // Добавляем время чтобы избежать смещения часового пояса
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        const formattedDate = modalDate.toLocaleDateString('ru-RU', options);

        $('#dayModalTitle').text(`Мероприятия на ${formattedDate}`);

        // Показываем загрузку
        $('#dayEventsList').html('<div class="text-center"><div class="spinner-border"></div></div>');
        $('#noEvents').hide();
        $('#dayEventsList').show();

        // Загружаем мероприятия дня
        $.get(`/competitions/get-day-events?date=${date}`, function(events) {
            $('#dayEventsList').empty();

            if (events && events.length > 0) {
                events.forEach(event => {
                    let eventTime = '';
                    if (event.time && event.time !== '00:00') {
                        eventTime = ` в ${event.time}`;
                    }
                    const eventElement = $(`
                        <div class="event-item mb-3 p-3 border rounded">
                            <h6 class="mb-2 text-primary">${event.name}</h6>
                            <p class="mb-1 text-muted small">${formattedDate}${eventTime}</p>
                            ${event.address ? `<p class="mb-2 small"><i class="fas fa-map-marker-alt me-1"></i> ${event.address}</p>` : ''}
                            <button class="btn btn-sm btn-outline-primary" onclick="editCompetition(${event.id})">
                                <i class="fas fa-edit me-1"></i> Редактировать
                            </button>
                        </div>
                    `);
                    $('#dayEventsList').append(eventElement);
                });
                $('#noEvents').hide();
                $('#dayEventsList').show();
            } else {
                $('#dayEventsList').hide();
                $('#noEvents').show();
            }

            $('#dayModal').modal('show');
        }).fail(function(xhr, status, error) {
            $('#dayEventsList').html('<div class="alert alert-danger">Ошибка загрузки мероприятий</div>');
            $('#noEvents').show();
            $('#dayModal').modal('show');
        });
    }

    function createCompetition() {
        // Заглушка для создания мероприятия
        if (currentSelectedDate) {
            alert(`Создание мероприятия на дату: ${currentSelectedDate}\n\nФункция будет реализована позже`);
        }
        $('#dayModal').modal('hide');
    }

    function editCompetition(competitionId) {
        // Заглушка для редактирования мероприятия
        alert(`Редактирование мероприятия ID: ${competitionId}\n\nФункция будет реализована позже`);
        $('#dayModal').modal('hide');
    }

    function showMessage(text, type) {
        $('#message').html(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        setTimeout(() => $('.alert').alert('close'), 5000);
    }
</script>

<style>
.calendar-grid {
    min-height: 400px;
}

.weekdays-row, .week-row {
    min-height: 80px;
}

.day-header {
    font-weight: 600;
    color: var(--superset-dark);
    padding: 0.5rem;
    background-color: var(--superset-light);
    border-radius: 8px;
    margin: 0 2px;
}

.day-cell {
    min-height: 100px;
}

.btn-day {
    width: 100%;
    height: 100%;
    border: 2px solid var(--superset-border);
    border-radius: 8px;
    background: white;
    transition: all 0.3s ease;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    font-size: 0.85rem;
}

.btn-day:hover {
    border-color: var(--superset-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(32, 167, 201, 0.15);
}

.btn-day.today {
    border-color: var(--superset-warning);
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
}

.btn-day.has-events {
    border-color: var(--superset-success);
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
}

.day-number {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.events-indicator {
    font-size: 0.8rem;
    color: var(--superset-success);
    min-height: 1rem;
    margin-bottom: 0.25rem;
}

.event-preview {
    font-size: 0.75rem;
    color: var(--superset-dark);
    font-weight: 500;
    line-height: 1.2;
    max-height: 2.4rem;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.event-item {
    background: var(--superset-light);
    border-left: 4px solid var(--superset-primary) !important;
    transition: all 0.3s ease;
}

.event-item:hover {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.event-item h6 {
    color: var(--superset-primary);
    margin: 0;
    font-weight: 600;
}

/* Адаптивность */
@media (max-width: 768px) {
    .day-cell {
        min-height: 80px;
    }

    .day-number {
        font-size: 0.9rem;
    }

    .events-indicator {
        font-size: 0.7rem;
    }

    .event-preview {
        font-size: 0.7rem;
        -webkit-line-clamp: 1;
        max-height: 1.2rem;
    }

    .btn-day {
        padding: 0.25rem;
        font-size: 0.8rem;
    }
}

@media (max-width: 576px) {
    .weekdays-row, .week-row {
        min-height: 60px;
    }

    .day-cell {
        min-height: 70px;
    }

    .event-preview {
        display: none;
    }
}
</style>
{% endblock %}