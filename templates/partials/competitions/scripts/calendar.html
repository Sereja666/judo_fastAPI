<!-- templates/partials/competitions/scripts/calendar.html -->
<script>
    function generateCalendar(year, month) {
        console.log('üîπ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è', year, month, '—Å–æ–±—ã—Ç–∏—è:', eventsByDate);

        const calendar = $('#calendar');
        calendar.empty();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let firstDayOfWeek = firstDay.getDay();
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        const daysInMonth = lastDay.getDate();
        let date = 1;
        let weekCount = 0;

        // –°–æ–∑–¥–∞–µ–º 6 –Ω–µ–¥–µ–ª—å (–º–∞–∫—Å–∏–º—É–º –¥–ª—è –º–µ—Å—è—Ü–∞)
        for (let week = 0; week < 6; week++) {
            if (date > daysInMonth && weekCount > 0) break;

            const weekRow = $('<div class="row week-row mb-2 g-1"></div>');

            for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                const dayCell = $('<div class="col day-cell"></div>');

                // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –≤ –Ω–∞—á–∞–ª–µ –º–µ—Å—è—Ü–∞
                if (week === 0 && dayOfWeek < firstDayOfWeek) {
                    dayCell.addClass('empty text-center p-2');
                    dayCell.html('<div class="empty-day"></div>');
                    weekRow.append(dayCell);
                    continue;
                }

                // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞
                if (date > daysInMonth) {
                    dayCell.addClass('empty text-center p-2');
                    dayCell.html('<div class="empty-day"></div>');
                    weekRow.append(dayCell);
                    continue;
                }

                // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫—É —Å –¥–∞—Ç–æ–π
                const currentDay = new Date(year, month, date);
                const dateString = formatDateForAPI(currentDay);
                const isToday = isSameDay(currentDay, new Date());
                const dayEvents = eventsByDate[dateString] || [];
                const hasEvents = dayEvents.length > 0;
                const eventsCount = dayEvents.length;

                let dayClass = 'btn-day';
                if (isToday) {
                    dayClass += ' today';
                }
                if (hasEvents) {
                    dayClass += ' has-events';
                }

                // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–ª–∏—Ç–∫–∏
                let dayContent = `
                    <div class="btn-day-content">
                        <div class="day-header-row">
                            <div class="day-number">${date}</div>
                `;

                if (eventsCount > 0) {
                    dayContent += `
                        <div class="events-counter">
                            <span class="badge">${eventsCount}</span>
                        </div>
                    `;
                }

                dayContent += `
                        </div>
                        <div class="day-events">
                `;

                if (eventsCount > 0) {
                    for (let i = 0; i < Math.min(eventsCount, 2); i++) {
                        const event = dayEvents[i];
                        const eventIcon = eventsCount > 1 && i === 1 ? 'ellipsis-h' : 'trophy';
                        dayContent += `
                            <div class="event-preview" title="${event.name}">
                                <i class="fas fa-${eventIcon}"></i>
                                <span>${truncateText(event.name, 15)}</span>
                            </div>
                        `;
                    }

                    if (eventsCount > 2) {
                        dayContent += `
                            <div class="event-preview text-muted">
                                <i class="fas fa-plus"></i>
                                <span>–µ—â–µ ${eventsCount - 2}</span>
                            </div>
                        `;
                    }
                } else {
                    dayContent += `
                        <div class="no-events">
                            <i class="far fa-calendar-times"></i>
                            <span>–ù–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</span>
                        </div>
                    `;
                }

                dayContent += `
                        </div>
                    </div>
                `;

                const dayButton = $(`
                    <button class="${dayClass}" data-date="${dateString}"
                            data-bs-toggle="tooltip" data-bs-html="true"
                            data-bs-title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π"
                            onclick="currentSelectedDate = '${dateString}'; openDayModal('${dateString}')">
                        ${dayContent}
                    </button>
                `);

                dayCell.append(dayButton);
                weekRow.append(dayCell);
                date++;
                weekCount++;
            }

            calendar.append(weekRow);
        }

        console.log('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω, –¥–Ω–µ–π:', weekCount);
        initializeTooltips();
    }

    function initializeTooltips() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ç—É–ª—Ç–∏–ø—ã
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => {
            const instance = bootstrap.Tooltip.getInstance(tooltip);
            if (instance) {
                instance.dispose();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ
        $('[data-bs-toggle="tooltip"]').tooltip({
            trigger: 'hover',
            placement: 'top',
            delay: {show: 500, hide: 100},
            html: true
        });
    }

    function loadDayEventsTooltip(dateString) {
        const dayEvents = eventsByDate[dateString] || [];
        if (dayEvents.length === 0) {
            updateDayTooltip(dateString, '<div class="small text-muted">–ù–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</div>');
            return;
        }

        let tooltipContent = '<div style="max-width: 250px; text-align: left;">';

        if (dayEvents.length === 1) {
            const event = dayEvents[0];
            tooltipContent += `
                <div class="mb-2">
                    <strong class="d-block mb-1">${event.name}</strong>
            `;
            if (event.address) {
                tooltipContent += `
                    <div class="text-muted small">
                        <i class="fas fa-map-marker-alt me-1"></i> ${event.address}
                    </div>
                `;
            }
            tooltipContent += '</div>';
        } else {
            tooltipContent += `<strong class="d-block mb-2">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è (${dayEvents.length}):</strong>`;
            dayEvents.forEach((event, index) => {
                tooltipContent += `
                    <div class="mb-2 pb-2 ${index < dayEvents.length - 1 ? 'border-bottom' : ''}">
                        <div class="fw-medium">${index + 1}. ${truncateText(event.name, 25)}</div>
                `;
                if (event.address) {
                    tooltipContent += `
                        <div class="text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i> ${truncateText(event.address, 20)}
                        </div>
                    `;
                }
                tooltipContent += '</div>';
            });
        }

        tooltipContent += '</div>';
        updateDayTooltip(dateString, tooltipContent);
    }

    function updateDayTooltip(dateString, tooltipContent) {
        const dayButton = $(`button[data-date="${dateString}"]`);

        if (!tooltipContent) {
            dayButton.removeAttr('data-bs-title');
            return;
        }

        dayButton.attr('data-bs-title', tooltipContent);

        const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
        if (tooltipInstance) {
            tooltipInstance.setContent({'.tooltip-inner': tooltipContent});
        } else {
            new bootstrap.Tooltip(dayButton[0], {
                trigger: 'hover',
                placement: 'top',
                delay: {show: 500, hide: 100},
                html: true
            });
        }
    }

    function updateMonthDisplay() {
        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];
        $('#currentMonth').text(`${monthNames[currentMonth]} ${currentYear}`);
    }

    function previousMonth() {
        console.log('‚¨ÖÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü');
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        updateMonthDisplay();
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    function nextMonth() {
        console.log('‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü');
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        updateMonthDisplay();
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    // –£–±–∏—Ä–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –¥–æ–±–∞–≤–ª—è–µ–º onclick –≤ –∫–Ω–æ–ø–∫—É
    $(document).ready(function() {
        console.log('üìÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –≥–æ—Ç–æ–≤');

        // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç—É–ª—Ç–∏–ø–æ–≤
        setTimeout(() => {
            $('.btn-day').each(function() {
                const date = $(this).data('date');
                if (date) {
                    loadDayEventsTooltip(date);
                }
            });
        }, 1500);
    });
</script>