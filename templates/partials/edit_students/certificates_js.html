<!-- templates/partials/edit_students/certificates_js.html -->
<script>
    // ================== –ú–ï–î–ò–¶–ò–ù–°–ö–ò–ï –°–ü–†–ê–í–ö–ò ==================

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–ø—Ä–∞–≤–æ–∫
    function loadMedicalCertificates(studentId) {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–ø—Ä–∞–≤–æ–∫ –¥–ª—è —É—á–µ–Ω–∏–∫–∞:', studentId);

        if (!studentId || studentId === 'new') {
            $('#certificatesContainer').html('<div class="text-muted">–°–ø—Ä–∞–≤–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞</div>');
            return;
        }

        $.get(`/edit-students/get-medical-certificates/${studentId}`, function(certificates) {
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–ø—Ä–∞–≤–∫–∏:', certificates);

            if (certificates.length === 0) {
                $('#certificatesContainer').html('<div class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–ø—Ä–∞–≤–æ–∫</div>');
                return;
            }

            let html = '';
            certificates.forEach(cert => {
                const startDate = cert.date_start ? new Date(cert.date_start).toLocaleDateString('ru-RU') : '‚Äî';
                const endDate = cert.date_end ? new Date(cert.date_end).toLocaleDateString('ru-RU') : '‚Äî';
                const isExpired = cert.date_end ? new Date(cert.date_end) < new Date() : false;
                const statusClass = isExpired ? 'text-danger' : (cert.active ? 'text-success' : 'text-muted');
                const statusText = isExpired ? '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞' : (cert.active ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞');

                html += `
                    <div class="card mb-2 ${isExpired ? 'border-danger' : ''}">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <strong>${cert.cert_name}</strong>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">–ù–∞—á–∞–ª–æ:</small><br>
                                    ${startDate}
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">–û–∫–æ–Ω—á–∞–Ω–∏–µ:</small><br>
                                    ${endDate}
                                </div>
                                <div class="col-md-2">
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                            onclick="editCertificate(${cert.id}, ${cert.cert_id}, '${cert.date_start}', '${cert.date_end}', ${cert.active}, '${cert.cert_name}')">
                                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            $('#certificatesContainer').html(html);
        }).fail(function(xhr, status, error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ–∫:', error);
            $('#certificatesContainer').html('<div class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ–∫</div>');
        });
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏
    function showAddCertificateForm() {
        console.log('üîÑ –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏');

        const studentId = $('#studentId').val();
        console.log('Student ID:', studentId);

        if (!studentId || studentId === 'new') {
            showMessage('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞', 'warning');
            return;
        }

        $('#certificateModalLabel').text('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏');
        $('#certificateId').val('');
        $('#certificateStudentId').val(studentId);
        $('#certificateForm')[0].reset();
        $('#cert_id').prop('disabled', false);
        $('#cert_active').prop('checked', true);
        $('#deleteCertificateBtn').addClass('hidden');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∏–ø—ã —Å–ø—Ä–∞–≤–æ–∫ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        loadCertificateTypes().then(() => {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = new bootstrap.Modal(document.getElementById('certificateModal'));
            modal.show();
        });
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏
    function editCertificate(certificateId, certId, dateStart, dateEnd, active, certName) {
        console.log('üîÑ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏:', certificateId);

        $('#certificateModalLabel').text(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏: ${certName}`);
        $('#certificateId').val(certificateId);
        $('#certificateStudentId').val($('#studentId').val());

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∏–ø—ã —Å–ø—Ä–∞–≤–æ–∫ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∏–ø
        loadCertificateTypes().then(() => {
            $('#cert_id').val(certId);
            $('#cert_id').prop('disabled', true); // –ó–∞–ø—Ä–µ—â–∞–µ–º –∏–∑–º–µ–Ω—è—Ç—å —Ç–∏–ø —Å–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏

            $('#cert_date_start').val(dateStart ? dateStart.split('T')[0] : '');
            $('#cert_date_end').val(dateEnd ? dateEnd.split('T')[0] : '');
            $('#cert_active').prop('checked', active);
            $('#deleteCertificateBtn').removeClass('hidden');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = new bootstrap.Modal(document.getElementById('certificateModal'));
            modal.show();
        });
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏
    function saveCertificate() {
        console.log('üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏');

        const formData = new FormData(document.getElementById('certificateForm'));
        const certificateId = $('#certificateId').val();

        // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }

        const url = certificateId ? '/edit-students/update-medical-certificate' : '/edit-students/add-medical-certificate';

        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            showMessage(data.message, 'success');

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('certificateModal'));
            modal.hide();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–ø—Ä–∞–≤–æ–∫
            loadMedicalCertificates($('#studentId').val());
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏: ' + error.message, 'danger');
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ —Å–ø—Ä–∞–≤–æ–∫
    function loadCertificateTypes() {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ —Å–ø—Ä–∞–≤–æ–∫');

        return new Promise((resolve, reject) => {
            if ($('#cert_id option').length > 1) {
                console.log('–¢–∏–ø—ã —Å–ø—Ä–∞–≤–æ–∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                resolve();
                return;
            }

            $.get('/edit-students/get-certificate-types', function(types) {
                console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã —Ç–∏–ø—ã —Å–ø—Ä–∞–≤–æ–∫:', types);

                let options = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–ø—Ä–∞–≤–∫–∏ --</option>';
                types.forEach(type => {
                    options += `<option value="${type.id}">${type.name}</option>`;
                });
                $('#cert_id').html(options);
                resolve();
            }).fail(function(xhr, status, error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —Å–ø—Ä–∞–≤–æ–∫:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —Å–ø—Ä–∞–≤–æ–∫', 'danger');
                reject(error);
            });
        });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏
    function deleteCertificate() {
        const certificateId = $('#certificateId').val();
        if (!certificateId) return;

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É?')) {
            return;
        }

        $.ajax({
            url: `/edit-students/delete-medical-certificate/${certificateId}`,
            type: 'DELETE',
            success: function(response) {
                showMessage(response.message, 'success');

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('certificateModal'));
                modal.hide();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–ø—Ä–∞–≤–æ–∫
                loadMedicalCertificates($('#studentId').val());
            },
            error: function(xhr, status, error) {
                showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏: ' + error, 'danger');
            }
        });
    }
</script>