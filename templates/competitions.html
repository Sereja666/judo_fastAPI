<!-- templates/competitions.html -->
{% extends "base.html" %}

{% block title %}Календарь мероприятий{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Календарь мероприятий</h1>
    <div>
        <button class="btn btn-outline-secondary" onclick="previousMonth()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <span id="currentMonth" class="mx-3 fw-bold fs-5"></span>
        <button class="btn btn-outline-secondary" onclick="nextMonth()">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>
            Календарь соревнований и мероприятий
        </h5>
    </div>
    <div class="card-body">
        <!-- Дни недели -->
        <div class="row weekdays-row mb-2">
            <div class="col day-header text-center">Пн</div>
            <div class="col day-header text-center">Вт</div>
            <div class="col day-header text-center">Ср</div>
            <div class="col day-header text-center">Чт</div>
            <div class="col day-header text-center">Пт</div>
            <div class="col day-header text-center">Сб</div>
            <div class="col day-header text-center">Вс</div>
        </div>

        <!-- Контейнер для календаря -->
        <div id="calendar" class="calendar-grid">
            <!-- Календарь будет генерироваться JavaScript -->
        </div>
    </div>
</div>

<!-- Модальное окно для мероприятий дня -->
<div class="modal fade" id="dayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayModalTitle">Мероприятия</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dayEventsList">
                    <!-- Список мероприятий будет здесь -->
                </div>
                <div id="noEvents" class="text-center py-4" style="display: none;">
                    <p class="text-muted">На этот день нет мероприятий</p>
                    <button class="btn btn-primary" onclick="showCompetitionForm()">
                        <i class="fas fa-plus"></i> Создать мероприятие
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для формы мероприятия -->
<div class="modal fade" id="competitionFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="competitionFormTitle">Создание мероприятия</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="competitionForm">
                    <input type="hidden" id="competitionId" name="competition_id">
                    <input type="hidden" id="competitionDate" name="date">

                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="competitionName" class="form-label">Название мероприятия *</label>
                                <input type="text" class="form-control" id="competitionName" name="name" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="competitionDateDisplay" class="form-label">Дата</label>
                                <input type="text" class="form-control" id="competitionDateDisplay" readonly style="background-color: #f8f9fa;">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="competitionAddress" class="form-label">Адрес проведения</label>
                        <textarea class="form-control" id="competitionAddress" name="address" rows="2"></textarea>
                    </div>

                    <!-- Медицинские справки -->
                    <div class="mb-4">
                        <label class="form-label">Требуемые медицинские справки</label>
                        <div id="certificatesList" class="border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                            <!-- Список справок будет здесь -->
                        </div>
                    </div>

                    <!-- Участники -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Участники</label>
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control" id="studentSearch" placeholder="Поиск ученика...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchStudent()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div id="studentsList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                    <!-- Список выбранных учеников будет здесь -->
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ответственные тренеры</label>
                                <div class="input-group mb-2">
                                    <select class="form-select" id="trainerSelect">
                                        <option value="">Выберите тренера...</option>
                                    </select>
                                    <button class="btn btn-outline-primary" type="button" onclick="addTrainer()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div id="trainersList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                    <!-- Список выбранных тренеров будет здесь -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="deleteCompetitionBtn" style="display: none;" onclick="deleteCompetition()">
                    <i class="fas fa-trash"></i> Удалить
                </button>
                <button type="button" class="btn btn-primary" onclick="saveCompetition()">
                    <i class="fas fa-save"></i> Сохранить
                </button>
            </div>
        </div>
    </div>
</div>

<div id="message" class="mt-3"></div>
{% endblock %}

{% block scripts %}
<script>
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();
    let eventsByDate = {}; // Храним мероприятия по датам
    let currentSelectedDate = null; // Текущая выбранная дата для модального окна

    // Данные для формы
    let allMedCertificates = [];
    let allStudents = [];
    let allTrainers = [];

    // Выбранные элементы в форме
    let selectedStudents = [];
    let selectedTrainers = [];
    let selectedCertificates = [];

    // Хранилище для данных о участниках мероприятий
    let competitionParticipants = {};

    $(document).ready(function() {
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        loadEventsForMonth(currentYear, currentMonth + 1);
        loadFormData(); // Загружаем данные для формы
    });

    function loadFormData() {
        // Загружаем данные для формы (справки, ученики, тренеры)
        $.get('/competitions/get-all-data', function(data) {
            allMedCertificates = data.med_cert_types || [];
            allStudents = data.students || [];
            allTrainers = data.trainers || [];

            // Заполняем список тренеров в селекте
            const trainerSelect = $('#trainerSelect');
            trainerSelect.empty().append('<option value="">Выберите тренера...</option>');
            allTrainers.forEach(trainer => {
                trainerSelect.append(`<option value="${trainer.id}">${trainer.name}</option>`);
            });

            // Заполняем список справок
            renderCertificatesList();

        }).fail(function() {
            showMessage('Ошибка загрузки данных формы', 'danger');
        });
    }

    function renderCertificatesList() {
        const certificatesList = $('#certificatesList');
        certificatesList.empty();

        allMedCertificates.forEach(cert => {
            const isSelected = selectedCertificates.includes(cert.id);
            const certElement = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${cert.id}"
                           id="cert_${cert.id}" ${isSelected ? 'checked' : ''}
                           onchange="toggleCertificate(${cert.id})">
                    <label class="form-check-label" for="cert_${cert.id}">
                        ${cert.name}
                    </label>
                </div>
            `;
            certificatesList.append(certElement);
        });
    }

    function toggleCertificate(certId) {
        const index = selectedCertificates.indexOf(certId);
        if (index > -1) {
            selectedCertificates.splice(index, 1);
        } else {
            selectedCertificates.push(certId);
        }
    }

    function searchStudent() {
        const searchTerm = $('#studentSearch').val().toLowerCase();
        if (!searchTerm) return;

        // Простой поиск по имени
        const filteredStudents = allStudents.filter(student =>
            student.name.toLowerCase().includes(searchTerm)
        );

        if (filteredStudents.length > 0) {
            const student = filteredStudents[0];
            if (!selectedStudents.includes(student.id)) {
                selectedStudents.push(student.id);
                renderStudentsList();
            }
            $('#studentSearch').val('');
        }
    }

    function addTrainer() {
        const trainerId = $('#trainerSelect').val();
        if (trainerId && !selectedTrainers.includes(parseInt(trainerId))) {
            selectedTrainers.push(parseInt(trainerId));
            renderTrainersList();
            $('#trainerSelect').val('');
        }
    }

    function renderStudentsList() {
        const studentsList = $('#studentsList');
        studentsList.empty();

        selectedStudents.forEach(studentId => {
            const student = allStudents.find(s => s.id === studentId);
            if (student) {
                const studentElement = `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <span>${student.name}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStudent(${studentId})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                studentsList.append(studentElement);
            }
        });
    }

    function renderTrainersList() {
        const trainersList = $('#trainersList');
        trainersList.empty();

        selectedTrainers.forEach(trainerId => {
            const trainer = allTrainers.find(t => t.id === trainerId);
            if (trainer) {
                const trainerElement = `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <span>${trainer.name}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTrainer(${trainerId})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                trainersList.append(trainerElement);
            }
        });
    }

    function removeStudent(studentId) {
        selectedStudents = selectedStudents.filter(id => id !== studentId);
        renderStudentsList();
    }

    function removeTrainer(trainerId) {
        selectedTrainers = selectedTrainers.filter(id => id !== trainerId);
        renderTrainersList();
    }

    function showCompetitionForm() {
        $('#dayModal').modal('hide');

        // Сбрасываем форму
        resetCompetitionForm();

        // Устанавливаем дату
        $('#competitionDate').val(currentSelectedDate);
        $('#competitionDateDisplay').val(formatDisplayDate(currentSelectedDate));

        $('#competitionFormTitle').text('Создание мероприятия');
        $('#deleteCompetitionBtn').hide();

        $('#competitionFormModal').modal('show');
    }

    function editCompetition(competitionId) {
        $('#dayModal').modal('hide');

        // Загружаем данные мероприятия
        $.get(`/competitions/get-competition-data/${competitionId}`, function(data) {
            // Заполняем форму
            $('#competitionId').val(data.competition.id);
            $('#competitionName').val(data.competition.name);
            $('#competitionAddress').val(data.competition.address || '');
            $('#competitionDate').val(data.competition.date ? data.competition.date.split('T')[0] : '');
            $('#competitionDateDisplay').val(formatDisplayDate(data.competition.date ? data.competition.date.split('T')[0] : ''));

            // Устанавливаем выбранные элементы
            selectedStudents = data.students || [];
            selectedTrainers = data.trainers || [];
            selectedCertificates = data.certificates || [];

            renderStudentsList();
            renderTrainersList();
            renderCertificatesList();

            $('#competitionFormTitle').text('Редактирование мероприятия');
            $('#deleteCompetitionBtn').show();

            $('#competitionFormModal').modal('show');

        }).fail(function() {
            showMessage('Ошибка загрузки данных мероприятия', 'danger');
        });
    }

    function resetCompetitionForm() {
        $('#competitionForm')[0].reset();
        $('#competitionId').val('');
        selectedStudents = [];
        selectedTrainers = [];
        selectedCertificates = [];

        renderStudentsList();
        renderTrainersList();
        renderCertificatesList();
    }

    function formatDisplayDate(dateString) {
        const date = new Date(dateString + 'T00:00:00');
        return date.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    }

    function saveCompetition() {
        const competitionId = $('#competitionId').val();
        const formData = new FormData();

        // Добавляем основные данные
        formData.append('name', $('#competitionName').val());
        formData.append('address', $('#competitionAddress').val());
        formData.append('date', $('#competitionDate').val());

        // Добавляем списки
        selectedStudents.forEach(id => formData.append('student_ids', id));
        selectedTrainers.forEach(id => formData.append('trainer_ids', id));
        selectedCertificates.forEach(id => formData.append('certificate_ids', id));

        const url = competitionId ? `/competitions/update-competition/${competitionId}` : '/competitions/create-competition';

        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showMessage(data.message, 'success');
                $('#competitionFormModal').modal('hide');

                // Очищаем кэш участников для этого мероприятия
                if (competitionId) {
                    delete competitionParticipants[competitionId];
                }

                // Обновляем календарь
                loadEventsForMonth(currentYear, currentMonth + 1);
            } else {
                showMessage(data.message || 'Ошибка сохранения', 'danger');
            }
        })
        .catch(error => {
            showMessage('Ошибка сохранения: ' + error, 'danger');
        });
    }

    function deleteCompetition() {
        const competitionId = $('#competitionId').val();
        if (!competitionId) return;

        if (confirm('Вы уверены, что хотите удалить это мероприятие?')) {
            // Здесь можно добавить эндпоинт для удаления
            showMessage('Функция удаления будет реализована позже', 'info');
        }
    }

    // Функции календаря
    function generateCalendar(year, month) {
        const calendar = $('#calendar');
        calendar.empty();

        // Первый день месяца
        const firstDay = new Date(year, month, 1);
        // Последний день месяца
        const lastDay = new Date(year, month + 1, 0);

        // День недели первого дня (0 - воскресенье, 1 - понедельник и т.д.)
        let firstDayOfWeek = firstDay.getDay();
        // Преобразуем к нашему формату (понедельник - 0)
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        // Количество дней в месяце
        const daysInMonth = lastDay.getDate();

        let date = 1;

        // Создаем недели
        for (let i = 0; i < 6; i++) {
            if (date > daysInMonth) break;

            const weekRow = $('<div class="row week-row mb-2"></div>');

            // Дни недели
            for (let j = 0; j < 7; j++) {
                const dayCell = $('<div class="col day-cell text-center p-2"></div>');

                if (i === 0 && j < firstDayOfWeek) {
                    // Пустые ячейки перед первым днем месяца
                    dayCell.html('&nbsp;');
                } else if (date > daysInMonth) {
                    // Пустые ячейки после последнего дня месяца
                    dayCell.html('&nbsp;');
                } else {
                    const currentDay = new Date(year, month, date);
                    // Исправляем проблему с часовым поясом - используем UTC дату
                    const dateString = formatDateForAPI(currentDay);
                    const isToday = isSameDay(currentDay, new Date());
                    const dayEvents = eventsByDate[dateString] || [];
                    const hasEvents = dayEvents.length > 0;

                    let dayClass = 'btn-day';
                    if (isToday) {
                        dayClass += ' today';
                    }
                    if (hasEvents) {
                        dayClass += ' has-events';
                    }

                    // Создаем содержимое дня
                    let dayContent = `
                        <div class="day-number">${date}</div>
                    `;

                    // Добавляем мероприятия если они есть
                    if (hasEvents) {
                        // Берем только первое мероприятие для отображения в календаре
                        const firstEvent = dayEvents[0];
                        dayContent += `
                            <div class="events-indicator">
                                <i class="fas fa-trophy me-1"></i>
                            </div>
                            <div class="event-preview" title="${firstEvent.name}">
                                ${truncateText(firstEvent.name, 15)}
                            </div>
                        `;
                    } else {
                        dayContent += '<div class="events-indicator"></div>';
                    }

                    // ВСЕГДА добавляем tooltip для дней с мероприятиями
                    const dayButton = $(`
                        <button class="btn ${dayClass}" data-date="${dateString}"
                                data-bs-toggle="tooltip" data-bs-html="true"
                                data-bs-title="Загрузка участников..."
                                onmouseenter="loadDayParticipants('${dateString}')">
                            ${dayContent}
                        </button>
                    `);

                    dayCell.append(dayButton);
                    date++;
                }

                weekRow.append(dayCell);
            }

            calendar.append(weekRow);
        }

        // Инициализируем tooltips после создания календаря
        initializeTooltips();
    }

    // Функция для инициализации tooltips
    function initializeTooltips() {
        // Удаляем существующие tooltips
        $('[data-bs-toggle="tooltip"]').tooltip('dispose');

        // Инициализируем новые tooltips с помощью jQuery
        $('[data-bs-toggle="tooltip"]').tooltip({
            trigger: 'hover',
            placement: 'top',
            delay: {show: 500, hide: 100},
            html: true
        });
    }

    // Функция для загрузки участников при наведении на день
    function loadDayParticipants(dateString) {
        const dayEvents = eventsByDate[dateString] || [];
        if (dayEvents.length === 0) return;

        // Для каждого мероприятия в этот день загружаем участников
        let loadedCount = 0;
        const allParticipants = [];

        dayEvents.forEach(event => {
            if (competitionParticipants[event.id]) {
                // Если данные уже загружены, используем их
                const participants = competitionParticipants[event.id] || [];
                const participantNames = participants.map(studentId => {
                    const student = allStudents.find(s => s.id === studentId);
                    return student ? student.name : 'Неизвестный ученик';
                });
                allParticipants.push(...participantNames);
                loadedCount++;

                if (loadedCount === dayEvents.length) {
                    updateDayTooltip(dateString, allParticipants);
                }
            } else {
                // Загружаем данные мероприятия
                $.get(`/competitions/get-competition-data/${event.id}`, function(data) {
                    competitionParticipants[event.id] = data.students || [];

                    const participants = competitionParticipants[event.id] || [];
                    const participantNames = participants.map(studentId => {
                        const student = allStudents.find(s => s.id === studentId);
                        return student ? student.name : 'Неизвестный ученик';
                    });
                    allParticipants.push(...participantNames);
                    loadedCount++;

                    if (loadedCount === dayEvents.length) {
                        updateDayTooltip(dateString, allParticipants);
                    }
                }).fail(function() {
                    // Если не удалось загрузить, просто увеличиваем счетчик
                    loadedCount++;
                    if (loadedCount === dayEvents.length) {
                        updateDayTooltip(dateString, allParticipants);
                    }
                });
            }
        });
    }

    // Функция для обновления tooltip дня
    function updateDayTooltip(dateString, participants) {
        // Убираем дубликаты
        const uniqueParticipants = [...new Set(participants)];

        let tooltipContent = '';
        if (uniqueParticipants.length > 0) {
            tooltipContent = `<strong>Участники:</strong><br>${uniqueParticipants.join('<br>')}`;
        } else {
            // ЕСЛИ НЕТ УЧАСТНИКОВ - НЕ ПОКАЗЫВАЕМ TOOLTIP ВООБЩЕ
            const dayButton = $(`button[data-date="${dateString}"]`);
            dayButton.attr('data-bs-title', '');
            const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
            if (tooltipInstance) {
                tooltipInstance.dispose();
            }
            return;
        }

        // Находим кнопку дня
        const dayButton = $(`button[data-date="${dateString}"]`);

        // Обновляем атрибут title
        dayButton.attr('data-bs-title', tooltipContent);

        // Обновляем tooltip
        const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
        if (tooltipInstance) {
            tooltipInstance.dispose();
        }

        // Создаем новый tooltip
        new bootstrap.Tooltip(dayButton[0], {
            trigger: 'hover',
            placement: 'top',
            delay: {show: 500, hide: 100},
            html: true
        });
    }

    // Функция для форматирования даты в правильный формат для API (без времени)
    function formatDateForAPI(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function truncateText(text, maxLength) {
        if (!text) return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    function isSameDay(date1, date2) {
        return date1.getDate() === date2.getDate() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getFullYear() === date2.getFullYear();
    }

    function updateMonthDisplay() {
        const monthNames = [
            'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];
        $('#currentMonth').text(`${monthNames[currentMonth]} ${currentYear}`);
    }

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        // Загружаем мероприятия для нового месяца
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
        // Загружаем мероприятия для нового месяца
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    function loadEventsForMonth(year, month) {
        $.get(`/competitions/get-events?year=${year}&month=${month}`, function(events) {
            // Сбрасываем хранилище мероприятий
            eventsByDate = {};

            // Группируем мероприятия по датам
            events.forEach(event => {
                if (event.date) {
                    // Используем ту же функцию форматирования даты
                    const eventDate = new Date(event.date);
                    const dateString = formatDateForAPI(eventDate);

                    if (!eventsByDate[dateString]) {
                        eventsByDate[dateString] = [];
                    }
                    eventsByDate[dateString].push(event);
                }
            });

            // Перерисовываем календарь с мероприятиями
            redrawCalendarWithEvents();

        }).fail(function(xhr, status, error) {
            showMessage('Ошибка загрузки мероприятий: ' + error, 'danger');
        });
    }

    // Функция для перерисовки календаря с мероприятиями
    function redrawCalendarWithEvents() {
        const calendar = $('#calendar');
        calendar.empty();

        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);

        let firstDayOfWeek = firstDay.getDay();
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        const daysInMonth = lastDay.getDate();
        let date = 1;

        for (let i = 0; i < 6; i++) {
            if (date > daysInMonth) break;

            const weekRow = $('<div class="row week-row mb-2"></div>');

            for (let j = 0; j < 7; j++) {
                const dayCell = $('<div class="col day-cell text-center p-2"></div>');

                if (i === 0 && j < firstDayOfWeek) {
                    dayCell.html('&nbsp;');
                } else if (date > daysInMonth) {
                    dayCell.html('&nbsp;');
                } else {
                    const currentDay = new Date(currentYear, currentMonth, date);
                    const dateString = formatDateForAPI(currentDay);
                    const isToday = isSameDay(currentDay, new Date());
                    const dayEvents = eventsByDate[dateString] || [];
                    const hasEvents = dayEvents.length > 0;

                    let dayClass = 'btn-day';
                    if (isToday) {
                        dayClass += ' today';
                    }
                    if (hasEvents) {
                        dayClass += ' has-events';
                    }

                    let dayContent = `<div class="day-number">${date}</div>`;

                    if (hasEvents) {
                        const firstEvent = dayEvents[0];
                        dayContent += `
                            <div class="events-indicator">
                                <i class="fas fa-trophy me-1"></i>
                            </div>
                            <div class="event-preview" title="${firstEvent.name}">
                                ${truncateText(firstEvent.name, 15)}
                            </div>
                        `;
                    } else {
                        dayContent += '<div class="events-indicator"></div>';
                    }

                    // ВСЕГДА добавляем tooltip для дней с мероприятиями
                    const dayButton = $(`
                        <button class="btn ${dayClass}" data-date="${dateString}"
                                data-bs-toggle="tooltip" data-bs-html="true"
                                data-bs-title="Загрузка участников..."
                                onmouseenter="loadDayParticipants('${dateString}')">
                            ${dayContent}
                        </button>
                    `);

                    dayCell.append(dayButton);
                    date++;
                }

                weekRow.append(dayCell);
            }

            calendar.append(weekRow);
        }

        // Инициализируем tooltips после перерисовки
        initializeTooltips();
    }

    // Обработчик клика по дню
    $(document).on('click', '.btn-day', function() {
        const date = $(this).data('date');
        currentSelectedDate = date; // Сохраняем выбранную дату
        openDayModal(date);
    });

    function openDayModal(date) {
        const modalDate = new Date(date + 'T00:00:00'); // Добавляем время чтобы избежать смещения часового пояса
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        const formattedDate = modalDate.toLocaleDateString('ru-RU', options);

        $('#dayModalTitle').text(`Мероприятия на ${formattedDate}`);

        // Показываем загрузку
        $('#dayEventsList').html('<div class="text-center"><div class="spinner-border"></div></div>');
        $('#noEvents').hide();
        $('#dayEventsList').show();

        // Загружаем мероприятия дня
        $.get(`/competitions/get-day-events?date=${date}`, function(events) {
            $('#dayEventsList').empty();

            if (events && events.length > 0) {
                events.forEach(event => {
                    let eventTime = '';
                    if (event.time && event.time !== '00:00') {
                        eventTime = ` в ${event.time}`;
                    }
                    const eventElement = $(`
                        <div class="event-item mb-3 p-3 border rounded">
                            <h6 class="mb-2 text-primary">${event.name}</h6>
                            <p class="mb-1 text-muted small">${formattedDate}${eventTime}</p>
                            ${event.address ? `<p class="mb-2 small"><i class="fas fa-map-marker-alt me-1"></i> ${event.address}</p>` : ''}
                            <button class="btn btn-sm btn-outline-primary" onclick="editCompetition(${event.id})">
                                <i class="fas fa-edit me-1"></i> Редактировать
                            </button>
                        </div>
                    `);
                    $('#dayEventsList').append(eventElement);
                });
                $('#noEvents').hide();
                $('#dayEventsList').show();
            } else {
                $('#dayEventsList').hide();
                $('#noEvents').show();
            }

            $('#dayModal').modal('show');
        }).fail(function(xhr, status, error) {
            $('#dayEventsList').html('<div class="alert alert-danger">Ошибка загрузки мероприятий</div>');
            $('#noEvents').show();
            $('#dayModal').modal('show');
        });
    }

    function showMessage(text, type) {
        $('#message').html(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        setTimeout(() => $('.alert').alert('close'), 5000);
    }

    // Функция для загрузки участников при наведении на день
    function loadDayParticipants(dateString) {
        const dayEvents = eventsByDate[dateString] || [];
        if (dayEvents.length === 0) return;

        // Для каждого мероприятия в этот день загружаем участников
        let loadedCount = 0;
        const allParticipants = [];

        dayEvents.forEach(event => {
            if (competitionParticipants[event.id]) {
                // Если данные уже загружены, используем их
                const participants = competitionParticipants[event.id] || [];
                const participantNames = participants.map(studentId => {
                    const student = allStudents.find(s => s.id === studentId);
                    return student ? student.name : 'Неизвестный ученик';
                });
                allParticipants.push(...participantNames);
                loadedCount++;

                if (loadedCount === dayEvents.length) {
                    updateDayTooltip(dateString, allParticipants);
                }
            } else {
                // Загружаем данные мероприятия
                $.get(`/competitions/get-competition-data/${event.id}`, function(data) {
                    competitionParticipants[event.id] = data.students || [];

                    const participants = competitionParticipants[event.id] || [];
                    const participantNames = participants.map(studentId => {
                        const student = allStudents.find(s => s.id === studentId);
                        return student ? student.name : 'Неизвестный ученик';
                    });
                    allParticipants.push(...participantNames);
                    loadedCount++;

                    if (loadedCount === dayEvents.length) {
                        updateDayTooltip(dateString, allParticipants);
                    }
                }).fail(function() {
                    // Если не удалось загрузить, просто увеличиваем счетчик
                    loadedCount++;
                    if (loadedCount === dayEvents.length) {
                        updateDayTooltip(dateString, allParticipants);
                    }
                });
            }
        });
    }

    // Функция для обновления tooltip дня
    function updateDayTooltip(dateString, participants) {
        // Убираем дубликаты
        const uniqueParticipants = [...new Set(participants)];

        // Находим кнопку дня
        const dayButton = $(`button[data-date="${dateString}"]`);

        if (uniqueParticipants.length === 0) {
            // Если нет участников - удаляем tooltip полностью
            dayButton.removeAttr('data-bs-toggle');
            dayButton.removeAttr('data-bs-title');
            dayButton.removeAttr('data-bs-html');
            dayButton.off('mouseenter');

            const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
            if (tooltipInstance) {
                tooltipInstance.dispose();
            }
            return;
        }

        let tooltipContent = `<strong>Участники:</strong><br>${uniqueParticipants.join('<br>')}`;

        // Обновляем атрибут title
        dayButton.attr('data-bs-title', tooltipContent);

        // Убедимся, что есть все необходимые атрибуты
        dayButton.attr('data-bs-toggle', 'tooltip');
        dayButton.attr('data-bs-html', 'true');

        // Обновляем tooltip
        const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
        if (tooltipInstance) {
            tooltipInstance.dispose();
        }

        // Создаем новый tooltip
        new bootstrap.Tooltip(dayButton[0], {
            trigger: 'hover',
            placement: 'top',
            delay: {show: 500, hide: 100},
            html: true
        });

        // Принудительно показываем tooltip (если курсор все еще на элементе)
        dayButton.tooltip('show');
    }

</script>

<style>

.calendar-grid {
    min-height: 400px;
}

.weekdays-row, .week-row {
    min-height: 80px;
}

.day-header {
    font-weight: 600;
    color: var(--superset-dark);
    padding: 0.5rem;
    background-color: var(--superset-light);
    border-radius: 8px;
    margin: 0 2px;
}

.day-cell {
    min-height: 100px;
}

.btn-day {
    width: 100%;
    height: 100%;
    border: 2px solid var(--superset-border);
    border-radius: 8px;
    background: white;
    transition: all 0.3s ease;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    font-size: 0.85rem;
}

.btn-day:hover {
    border-color: var(--superset-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(32, 167, 201, 0.15);
}

.btn-day.today {
    border-color: var(--superset-warning);
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
}

.btn-day.has-events {
    border-color: var(--superset-success);
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
}

.day-number {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.events-indicator {
    font-size: 0.8rem;
    color: var(--superset-success);
    min-height: 1rem;
    margin-bottom: 0.25rem;
}

.event-preview {
    font-size: 0.75rem;
    color: var(--superset-dark);
    font-weight: 500;
    line-height: 1.2;
    max-height: 2.4rem;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.event-item {
    background: var(--superset-light);
    border-left: 4px solid var(--superset-primary) !important;
    transition: all 0.3s ease;
}

.event-item:hover {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.event-item h6 {
    color: var(--superset-primary);
    margin: 0;
    font-weight: 600;
}

/* Стили для tooltip */
.tooltip {
    --bs-tooltip-bg: var(--superset-dark);
    --bs-tooltip-color: white;
}

.tooltip .tooltip-inner {
    background-color: var(--superset-dark);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    max-width: 300px;
    text-align: left;
}

.tooltip.show {
    opacity: 1;
}

/* Адаптивность */
@media (max-width: 768px) {
    .day-cell {
        min-height: 80px;
    }

    .day-number {
        font-size: 0.9rem;
    }

    .events-indicator {
        font-size: 0.7rem;
    }

    .event-preview {
        font-size: 0.7rem;
        -webkit-line-clamp: 1;
        max-height: 1.2rem;
    }

    .btn-day {
        padding: 0.25rem;
        font-size: 0.8rem;
    }

    .tooltip .tooltip-inner {
        max-width: 200px;
    }
}

@media (max-width: 576px) {
    .weekdays-row, .week-row {
        min-height: 60px;
    }

    .day-cell {
        min-height: 70px;
    }

    .event-preview {
        display: none;
    }

    .tooltip .tooltip-inner {
        max-width: 150px;
        font-size: 0.8rem;
    }
}
</style>
{% endblock %}