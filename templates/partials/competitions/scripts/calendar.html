<!-- templates/partials/competitions/scripts/calendar.html -->
<script>
    function generateCalendar(year, month) {
        const calendar = $('#calendar');
        calendar.empty();

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let firstDayOfWeek = firstDay.getDay();
        // Преобразуем: Пн=0, Вт=1, Ср=2, Чт=3, Пт=4, Сб=5, Вс=6
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        const daysInMonth = lastDay.getDate();
        let date = 1;
        let weeksGenerated = 0;

        // Создаем максимум 6 недель
        for (let week = 0; week < 6; week++) {
            // Если мы уже прошли все дни месяца и это не первая неделя
            if (date > daysInMonth && weeksGenerated > 0) break;

            const weekRow = $('<div class="row week-row"></div>');
            let weekHasDays = false;

            for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                const dayCell = $('<div class="col day-cell p-1"></div>');

                // Пустые ячейки в начале месяца (перед первым числом)
                if (week === 0 && dayOfWeek < firstDayOfWeek) {
                    dayCell.addClass('empty');
                    dayCell.html('<div class="empty-day"></div>');
                    weekRow.append(dayCell);
                    continue;
                }

                // Пустые ячейки после последнего дня месяца
                if (date > daysInMonth) {
                    dayCell.addClass('empty');
                    dayCell.html('<div class="empty-day"></div>');
                    weekRow.append(dayCell);
                    continue;
                }

                // Создаем ячейку с датой
                const currentDay = new Date(year, month, date);
                const dateString = formatDateForAPI(currentDay);
                const isToday = isSameDay(currentDay, new Date());
                const dayEvents = eventsByDate[dateString] || [];
                const hasEvents = dayEvents.length > 0;
                const eventsCount = dayEvents.length;

                let dayClass = 'btn-day';
                if (isToday) {
                    dayClass += ' today';
                }
                if (hasEvents) {
                    dayClass += ' has-events';
                }

                // Создаем содержимое плитки
                let dayContent = `
                    <div class="btn-day-content">
                        <div class="day-header-row">
                            <div class="day-number">${date}</div>
                `;

                if (eventsCount > 0) {
                    dayContent += `
                        <div class="events-counter">
                            <span class="badge bg-primary rounded-pill">${eventsCount}</span>
                        </div>
                    `;
                }

                dayContent += `
                        </div>
                        <div class="day-events">
                `;

                if (eventsCount > 0) {
                    for (let i = 0; i < Math.min(eventsCount, 2); i++) {
                        const event = dayEvents[i];
                        const eventIcon = eventsCount > 1 && i === 1 ? 'ellipsis-h' : 'trophy';
                        dayContent += `
                            <div class="event-preview" title="${event.name}">
                                <i class="fas fa-${eventIcon}"></i>
                                <span>${truncateText(event.name, 12)}</span>
                            </div>
                        `;
                    }

                    if (eventsCount > 2) {
                        dayContent += `
                            <div class="event-preview text-muted">
                                <i class="fas fa-plus"></i>
                                <span>еще ${eventsCount - 2}</span>
                            </div>
                        `;
                    }
                } else {
                    dayContent += `
                        <div class="no-events">
                            <i class="far fa-calendar-times"></i>
                            <span>Нет мероприятий</span>
                        </div>
                    `;
                }

                dayContent += `
                        </div>
                    </div>
                `;

                const dayButton = $(`
                    <button class="${dayClass}" data-date="${dateString}"
                            data-bs-toggle="tooltip" data-bs-html="true"
                            data-bs-title="Нажмите для просмотра мероприятий"
                            onclick="currentSelectedDate = '${dateString}'; openDayModal('${dateString}')">
                        ${dayContent}
                    </button>
                `);

                dayCell.append(dayButton);
                weekRow.append(dayCell);
                date++;
                weekHasDays = true;
            }

            // Добавляем строку только если в ней есть дни
            if (weekHasDays) {
                calendar.append(weekRow);
                weeksGenerated++;
            }
        }

        // Если нет ни одной строки с днями, добавляем сообщение
        if (weeksGenerated === 0) {
            calendar.append(`
                <div class="text-center py-5 text-muted">
                    <i class="fas fa-calendar-times fa-3x mb-3"></i>
                    <p>Нет данных для отображения</p>
                </div>
            `);
        }

        // Обновляем тултипы
        initializeTooltips();

        // Выравниваем сетку после отрисовки
        fixCalendarGrid();
    }

    function initializeTooltips() {
        // Удаляем старые тултипы
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(tooltip => {
            const instance = bootstrap.Tooltip.getInstance(tooltip);
            if (instance) {
                instance.dispose();
            }
        });

        // Инициализируем новые
        $('[data-bs-toggle="tooltip"]').tooltip({
            trigger: 'hover',
            placement: 'top',
            delay: {show: 500, hide: 100},
            html: true
        });
    }

    function loadDayEventsTooltip(dateString) {
        const dayEvents = eventsByDate[dateString] || [];
        if (dayEvents.length === 0) {
            updateDayTooltip(dateString, '<div class="small text-muted">Нет мероприятий</div>');
            return;
        }

        let tooltipContent = '<div style="max-width: 250px; text-align: left;">';

        if (dayEvents.length === 1) {
            const event = dayEvents[0];
            tooltipContent += `
                <div class="mb-2">
                    <strong class="d-block mb-1">${event.name}</strong>
            `;
            if (event.address) {
                tooltipContent += `
                    <div class="text-muted small">
                        <i class="fas fa-map-marker-alt me-1"></i> ${event.address}
                    </div>
                `;
            }
            tooltipContent += '</div>';
        } else {
            tooltipContent += `<strong class="d-block mb-2">Мероприятия (${dayEvents.length}):</strong>`;
            dayEvents.forEach((event, index) => {
                tooltipContent += `
                    <div class="mb-2 pb-2 ${index < dayEvents.length - 1 ? 'border-bottom' : ''}">
                        <div class="fw-medium">${index + 1}. ${truncateText(event.name, 25)}</div>
                `;
                if (event.address) {
                    tooltipContent += `
                        <div class="text-muted small">
                            <i class="fas fa-map-marker-alt me-1"></i> ${truncateText(event.address, 20)}
                        </div>
                    `;
                }
                tooltipContent += '</div>';
            });
        }

        tooltipContent += '</div>';
        updateDayTooltip(dateString, tooltipContent);
    }

    function updateDayTooltip(dateString, tooltipContent) {
        const dayButton = $(`button[data-date="${dateString}"]`);

        if (!tooltipContent) {
            dayButton.removeAttr('data-bs-title');
            return;
        }

        dayButton.attr('data-bs-title', tooltipContent);

        const tooltipInstance = bootstrap.Tooltip.getInstance(dayButton[0]);
        if (tooltipInstance) {
            tooltipInstance.setContent({'.tooltip-inner': tooltipContent});
        } else {
            new bootstrap.Tooltip(dayButton[0], {
                trigger: 'hover',
                placement: 'top',
                delay: {show: 500, hide: 100},
                html: true
            });
        }
    }

    function updateMonthDisplay() {
        const monthNames = [
            'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
            'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
        ];
        $('#currentMonth').text(`${monthNames[currentMonth]} ${currentYear}`);
    }

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        updateMonthDisplay();
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        updateMonthDisplay();
        loadEventsForMonth(currentYear, currentMonth + 1);
    }

    function fixCalendarGrid() {
        // Ждем отрисовки DOM
        setTimeout(() => {
            // Находим все заголовки дней недели
            const headers = $('.weekdays-row .col');
            const cells = $('.week-row:first .day-cell');

            // Скрываем заголовки, для которых нет соответствующих ячеек в первой строке
            headers.each(function(index) {
                const header = $(this);
                const correspondingCell = cells.eq(index);

                if (correspondingCell.length && correspondingCell.hasClass('empty')) {
                    header.css('opacity', '0.3');
                } else {
                    header.css('opacity', '1');
                }
            });

            // Выравниваем высоту всех ячеек в каждой строке
            $('.week-row').each(function() {
                const $cells = $(this).find('.day-cell');
                let maxHeight = 0;

                // Находим максимальную высоту
                $cells.each(function() {
                    const height = $(this).outerHeight();
                    if (height > maxHeight) maxHeight = height;
                });

                // Устанавливаем одинаковую минимальную высоту
                if (maxHeight > 0) {
                    $cells.css('min-height', maxHeight + 'px');
                }
            });

            // Проверяем совпадение ширины заголовков и ячеек
            const firstHeader = headers.first();
            const firstCell = cells.first();

            if (firstHeader.length && firstCell.length) {
                const headerWidth = firstHeader.outerWidth();
                const cellWidth = firstCell.outerWidth();

                // Если ширина отличается больше чем на 2px, корректируем
                if (Math.abs(headerWidth - cellWidth) > 2) {
                    const targetWidth = Math.max(headerWidth, cellWidth);
                    headers.css('width', targetWidth + 'px');
                    $('.day-cell').css('width', targetWidth + 'px');
                }
            }
        }, 50);
    }

    // Глобальная функция для обновления календаря извне
    function refreshCalendar() {
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
    }

    // Инициализация при загрузке страницы
    $(document).ready(function() {
        // Даем время на загрузку событий
        setTimeout(() => {
            $('.btn-day').each(function() {
                const date = $(this).data('date');
                if (date) {
                    loadDayEventsTooltip(date);
                }
            });
        }, 1000);
    });
</script>