<!-- templates/partials/edit_students/main_js.html -->
<script>
    // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ jQuery
    function waitForjQuery() {
        if (typeof window.jQuery === 'undefined') {
            // jQuery –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∂–¥–µ–º
            console.log('‚è≥ –û–∂–∏–¥–∞—é –∑–∞–≥—Ä—É–∑–∫—É jQuery...');
            setTimeout(waitForjQuery, 100);
        } else {
            // jQuery –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º
            console.log('‚úÖ jQuery –∑–∞–≥—Ä—É–∂–µ–Ω, –≤–µ—Ä—Å–∏—è:', $.fn.jquery);
            initializePage();
        }
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
    document.addEventListener('DOMContentLoaded', waitForjQuery);

    function initializePage() {
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–µ–Ω–∏–∫–æ–≤');

        // –¢–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º $
        $(function() {
            console.log('‚úÖ jQuery ready —Å–æ–±—ã—Ç–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ');

            // Select2
            $('#studentSelect').select2({
                language: "ru",
                placeholder: "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è —É—á–µ–Ω–∏–∫–∞",
                allowClear: true
            }).on('change', function() {
                const studentId = $(this).val();
                console.log('–í—ã–±—Ä–∞–Ω —É—á–µ–Ω–∏–∫ ID:', studentId);

                if (studentId) {
                    loadStudentData(studentId);
                    $('#studentCard').removeClass('hidden');
                } else {
                    $('#studentCard').addClass('hidden');
                }
            });

            console.log('‚úÖ Select2 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        });
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    function loadStudentData(studentId) {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞ ID:', studentId);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch –≤–º–µ—Å—Ç–æ $.get –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        fetch(`/edit-students/get-student-data/${studentId}`)
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                return response.json();
            })
            .then(student => {
                console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞');

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —É—á–µ–Ω–∏–∫–∞
                document.getElementById('studentId').value = student.id;
                document.getElementById('name').value = student.name || '';
                document.getElementById('birthday').value = student.birthday ? student.birthday.split('T')[0] : '';
                document.getElementById('sport_discipline').value = student.sport_discipline || '';
                document.getElementById('rang').value = student.rang || '';
                document.getElementById('sports_rank').value = student.sports_rank || '';
                document.getElementById('sex').value = student.sex || '';
                document.getElementById('weight').value = student.weight || '';
                document.getElementById('telephone').value = student.telephone || '';
                document.getElementById('head_trainer_id').value = student.head_trainer_id || '';
                document.getElementById('second_trainer_id').value = student.second_trainer_id || '';
                document.getElementById('price').value = student.price || '';
                document.getElementById('payment_day').value = student.payment_day || '';
                document.getElementById('classes_remaining').value = student.classes_remaining || '';
                document.getElementById('expected_payment_date').value = student.expected_payment_date ? student.expected_payment_date.split('T')[0] : '';
                document.getElementById('parent1').value = student.parent1 || '';
                document.getElementById('parent2').value = student.parent2 || '';
                document.getElementById('date_start').value = student.date_start ? student.date_start.replace('Z', '').substring(0, 16) : '';
                document.getElementById('telegram_id').value = student.telegram_id || '';
                document.getElementById('active').checked = student.active !== false;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (typeof loadStudentParents === 'function') loadStudentParents(studentId);
                if (typeof loadMedicalCertificates === 'function') loadMedicalCertificates(studentId);
                if (typeof loadAwards === 'function') loadAwards(studentId);

            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞', 'danger');
            });
    }

    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        if (messageDiv) {
            messageDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${text}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    }
</script>