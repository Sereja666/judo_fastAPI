<!-- templates/competitions.html -->
{% extends "base.html" %}

{% block title %}–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</h1>
    <div>
        <button class="btn btn-outline-secondary" onclick="previousMonth()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <span id="currentMonth" class="mx-3 fw-bold fs-5"></span>
        <button class="btn btn-outline-secondary" onclick="nextMonth()">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0">
            <i class="fas fa-calendar-alt me-2"></i>
            –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
        </h5>
    </div>
    <div class="card-body">
        <!-- –î–Ω–∏ –Ω–µ–¥–µ–ª–∏ -->
        <div class="row weekdays-row mb-2">
            <div class="col day-header text-center">–ü–Ω</div>
            <div class="col day-header text-center">–í—Ç</div>
            <div class="col day-header text-center">–°—Ä</div>
            <div class="col day-header text-center">–ß—Ç</div>
            <div class="col day-header text-center">–ü—Ç</div>
            <div class="col day-header text-center">–°–±</div>
            <div class="col day-header text-center">–í—Å</div>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è -->
        <div id="calendar" class="calendar-grid">
            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è JavaScript -->
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–Ω—è -->
<div class="modal fade" id="dayModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayModalTitle">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="dayEventsList">
                    <!-- –°–ø–∏—Å–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
                <div id="noEvents" class="text-center py-4">
                    <p class="text-muted">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π</p>
                    <button class="btn btn-primary" onclick="createCompetition()">
                        <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<div id="message" class="mt-3"></div>
{% endblock %}

{% block scripts %}
<script>
    let currentDate = new Date();
    let currentYear = currentDate.getFullYear();
    let currentMonth = currentDate.getMonth();
    let eventsByDate = {}; // –•—Ä–∞–Ω–∏–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ –¥–∞—Ç–∞–º

    $(document).ready(function() {
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
    });

    function generateCalendar(year, month) {
        const calendar = $('#calendar');
        calendar.empty();

        // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
        const firstDay = new Date(year, month, 1);
        // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
        const lastDay = new Date(year, month + 1, 0);
        
        // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (0 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 - –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –∏ —Ç.–¥.)
        let firstDayOfWeek = firstDay.getDay();
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫ –Ω–∞—à–µ–º—É —Ñ–æ—Ä–º–∞—Ç—É (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - 0)
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
        const daysInMonth = lastDay.getDate();

        let date = 1;
        
        // –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–µ–ª–∏
        for (let i = 0; i < 6; i++) {
            if (date > daysInMonth) break;
            
            const weekRow = $('<div class="row week-row mb-2"></div>');
            
            // –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
            for (let j = 0; j < 7; j++) {
                const dayCell = $('<div class="col day-cell text-center p-2"></div>');
                
                if (i === 0 && j < firstDayOfWeek) {
                    // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –¥–Ω–µ–º –º–µ—Å—è—Ü–∞
                    dayCell.html('&nbsp;');
                } else if (date > daysInMonth) {
                    // –ü—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞
                    dayCell.html('&nbsp;');
                } else {
                    const currentDay = new Date(year, month, date);
                    const dateString = currentDay.toISOString().split('T')[0];
                    const isToday = isSameDay(currentDay, new Date());
                    const dayEvents = eventsByDate[dateString] || [];
                    const hasEvents = dayEvents.length > 0;
                    
                    let dayClass = 'day-number';
                    if (isToday) {
                        dayClass += ' today';
                    }
                    if (hasEvents) {
                        dayClass += ' has-events';
                    }
                    
                    // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–Ω—è
                    let dayContent = `
                        <div class="day-number">${date}</div>
                    `;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                    if (hasEvents) {
                        // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
                        const firstEvent = dayEvents[0];
                        dayContent += `
                            <div class="events-indicator">
                                <i class="fas fa-trophy me-1"></i>
                            </div>
                            <div class="event-preview" title="${firstEvent.name}">
                                ${truncateText(firstEvent.name, 15)}
                            </div>
                        `;
                    } else {
                        dayContent += '<div class="events-indicator"></div>';
                    }
                    
                    const dayButton = $(`
                        <button class="btn btn-day ${dayClass}" data-date="${dateString}">
                            ${dayContent}
                        </button>
                    `);
                    
                    dayCell.append(dayButton);
                    date++;
                }
                
                weekRow.append(dayCell);
            }
            
            calendar.append(weekRow);
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –º–µ—Å—è—Ü–∞
        loadEventsForMonth(year, month + 1);
    }

    function truncateText(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    function isSameDay(date1, date2) {
        return date1.getDate() === date2.getDate() &&
               date1.getMonth() === date2.getMonth() &&
               date1.getFullYear() === date2.getFullYear();
    }

    function updateMonthDisplay() {
        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];
        $('#currentMonth').text(`${monthNames[currentMonth]} ${currentYear}`);
    }

    function previousMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
        updateMonthDisplay();
    }

    function loadEventsForMonth(year, month) {
        console.log(`üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –∑–∞ ${year}-${month}`);
        
        $.get(`/competitions/get-events?year=${year}&month=${month}`, function(events) {
            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${events.length} –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π`, events);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
            eventsByDate = {};
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–æ –¥–∞—Ç–∞–º
            events.forEach(event => {
                if (event.date) {
                    const eventDate = new Date(event.date);
                    const dateString = eventDate.toISOString().split('T')[0];
                    
                    if (!eventsByDate[dateString]) {
                        eventsByDate[dateString] = [];
                    }
                    eventsByDate[dateString].push(event);
                }
            });
            
            console.log('üìÖ –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:', eventsByDate);
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏
            generateCalendar(currentYear, currentMonth);
            
        }).fail(function(xhr, status, error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π:', error);
            console.log('–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', xhr.responseText);
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: ' + error, 'danger');
            
            // –í—Å–µ —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å, –Ω–æ –±–µ–∑ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
            eventsByDate = {};
            generateCalendar(currentYear, currentMonth);
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –¥–Ω—é
    $(document).on('click', '.btn-day', function() {
        const date = $(this).data('date');
        openDayModal(date);
    });

    function openDayModal(date) {
        const modalDate = new Date(date);
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        const formattedDate = modalDate.toLocaleDateString('ru-RU', options);
        
        $('#dayModalTitle').text(`–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ ${formattedDate}`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        $('#dayEventsList').html('<div class="text-center"><div class="spinner-border"></div></div>');
        $('#noEvents').hide();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–Ω—è
        $.get(`/competitions/get-day-events?date=${date}`, function(events) {
            $('#dayEventsList').empty();
            
            if (events.length > 0) {
                events.forEach(event => {
                    const eventTime = event.time ? ` –≤ ${event.time}` : '';
                    const eventElement = $(`
                        <div class="event-item mb-3 p-3 border rounded">
                            <h6 class="mb-2 text-primary">${event.name}</h6>
                            <p class="mb-1 text-muted small">${formattedDate}${eventTime}</p>
                            ${event.address ? `<p class="mb-2 small"><i class="fas fa-map-marker-alt me-1"></i> ${event.address}</p>` : ''}
                            <button class="btn btn-sm btn-outline-primary" onclick="editCompetition(${event.id})">
                                <i class="fas fa-edit me-1"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                    `);
                    $('#dayEventsList').append(eventElement);
                });
                $('#noEvents').hide();
                $('#dayEventsList').show();
            } else {
                $('#dayEventsList').empty();
                $('#noEvents').show();
                $('#dayEventsList').hide();
            }
            
            $('#dayModal').modal('show');
        }).fail(function(xhr, status, error) {
            $('#dayEventsList').html('<div class="alert alert-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π: ' + error + '</div>');
            $('#noEvents').show();
            $('#dayModal').modal('show');
        });
    }

    function createCompetition() {
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        const date = $('#dayModal').data('currentDate');
        alert(`–°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –Ω–∞ –¥–∞—Ç—É: ${date}\n\n–§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ`);
        $('#dayModal').modal('hide');
    }

    function editCompetition(competitionId) {
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        alert(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è ID: ${competitionId}\n\n–§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ`);
        $('#dayModal').modal('hide');
    }

    function showMessage(text, type) {
        $('#message').html(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        setTimeout(() => $('.alert').alert('close'), 5000);
    }
</script>

<style>
.calendar-grid {
    min-height: 400px;
}

.weekdays-row, .week-row {
    min-height: 80px;
}

.day-header {
    font-weight: 600;
    color: var(--superset-dark);
    padding: 0.5rem;
    background-color: var(--superset-light);
    border-radius: 8px;
    margin: 0 2px;
}

.day-cell {
    min-height: 100px;
}

.btn-day {
    width: 100%;
    height: 100%;
    border: 2px solid var(--superset-border);
    border-radius: 8px;
    background: white;
    transition: all 0.3s ease;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    font-size: 0.85rem;
}

.btn-day:hover {
    border-color: var(--superset-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(32, 167, 201, 0.15);
}

.btn-day.today {
    border-color: var(--superset-warning);
    background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
}

.btn-day.has-events {
    border-color: var(--superset-success);
    background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
}

.day-number {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.events-indicator {
    font-size: 0.8rem;
    color: var(--superset-success);
    min-height: 1rem;
    margin-bottom: 0.25rem;
}

.event-preview {
    font-size: 0.75rem;
    color: var(--superset-dark);
    font-weight: 500;
    line-height: 1.2;
    max-height: 2.4rem;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.event-item {
    background: var(--superset-light);
    border-left: 4px solid var(--superset-primary) !important;
    transition: all 0.3s ease;
}

.event-item:hover {
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.event-item h6 {
    color: var(--superset-primary);
    margin: 0;
    font-weight: 600;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .day-cell {
        min-height: 80px;
    }
    
    .day-number {
        font-size: 0.9rem;
    }
    
    .events-indicator {
        font-size: 0.7rem;
    }
    
    .event-preview {
        font-size: 0.7rem;
        -webkit-line-clamp: 1;
        max-height: 1.2rem;
    }
    
    .btn-day {
        padding: 0.25rem;
        font-size: 0.8rem;
    }
}

@media (max-width: 576px) {
    .weekdays-row, .week-row {
        min-height: 60px;
    }
    
    .day-cell {
        min-height: 70px;
    }
    
    .event-preview {
        display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    }
}
</style>
{% endblock %}