<!-- templates/partials/edit_students/main_js.html -->
<script>
    // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—á–µ–Ω–∏–∫–æ–≤');

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ jQuery –∑–∞–≥—Ä—É–∂–µ–Ω
        if (typeof window.jQuery === 'undefined') {
            console.error('‚ùå jQuery –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
            return;
        }

        console.log('‚úÖ jQuery –∑–∞–≥—Ä—É–∂–µ–Ω, –≤–µ—Ä—Å–∏—è:', $.fn.jquery);

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
        $(document).ready(function() {
            console.log('‚úÖ jQuery ready —Å–æ–±—ã—Ç–∏–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ');

            // Select2
            $('#studentSelect').select2({
                language: "ru",
                placeholder: "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è —É—á–µ–Ω–∏–∫–∞",
                allowClear: true
            }).on('change', function() {
                const studentId = $(this).val();
                console.log('–í—ã–±—Ä–∞–Ω —É—á–µ–Ω–∏–∫ ID:', studentId);

                if (studentId) {
                    loadStudentData(studentId);
                    $('#studentCard').removeClass('hidden');
                } else {
                    $('#studentCard').addClass('hidden');
                }
            });

            console.log('‚úÖ Select2 –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏
    function loadStudentData(studentId) {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞ ID:', studentId);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch –≤–º–µ—Å—Ç–æ $.get –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
        fetch(`/edit-students/get-student-data/${studentId}`)
            .then(response => {
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                return response.json();
            })
            .then(student => {
                console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞:', student);

                // –°–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
                const fields = {
                    'studentId': student.id,
                    'name': student.name || '',
                    'birthday': student.birthday ? student.birthday.split('T')[0] : '',
                    'sport_discipline': student.sport_discipline || '',
                    'rang': student.rang || '',
                    'sports_rank': student.sports_rank || '',
                    'sex': student.sex || '',
                    'weight': student.weight || '',
                    'telephone': student.telephone || '',
                    'head_trainer_id': student.head_trainer_id || '',
                    'second_trainer_id': student.second_trainer_id || '',
                    'price': student.price || '',
                    'payment_day': student.payment_day || '',
                    'classes_remaining': student.classes_remaining || '',
                    'expected_payment_date': student.expected_payment_date ? student.expected_payment_date.split('T')[0] : '',
                    'parent1': student.parent1 || '',
                    'parent2': student.parent2 || '',
                    'telegram_id': student.telegram_id || ''
                };

                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∏—Ö —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è
                for (const [fieldId, value] of Object.entries(fields)) {
                    const element = document.getElementById(fieldId);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = value === true || value === 'true' || value === 'on';
                        } else {
                            element.value = value;
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç ${fieldId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                    }
                }

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Å–æ–±—ã–µ –ø–æ–ª—è
                const dateStartElement = document.getElementById('date_start');
                if (dateStartElement && student.date_start) {
                    dateStartElement.value = student.date_start.replace('Z', '').substring(0, 16);
                }

                const activeElement = document.getElementById('active');
                if (activeElement) {
                    activeElement.checked = student.active !== false;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ü–µ–Ω–µ
                if (student.price) {
                    const priceSelect = document.getElementById('price');
                    if (priceSelect) {
                        const selectedOption = priceSelect.querySelector(`option[value="${student.price}"]`);
                        if (selectedOption) {
                            const priceAmount = selectedOption.dataset.priceAmount;
                            const classesCount = selectedOption.dataset.classesCount;

                            const priceInfo = document.getElementById('priceInfo');
                            if (priceInfo) {
                                let infoText = '';
                                if (priceAmount) infoText += `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceAmount} —Ä—É–±. `;
                                if (classesCount) infoText += `–ó–∞–Ω—è—Ç–∏–π –≤ —Ç–∞—Ä–∏—Ñ–µ: ${classesCount}`;
                                priceInfo.textContent = infoText;
                            }
                        }
                    }
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç)
                setTimeout(() => {
                    if (typeof loadStudentParents === 'function') {
                        try {
                            loadStudentParents(studentId);
                        } catch (e) {
                            console.warn('–§—É–Ω–∫—Ü–∏—è loadStudentParents –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                        }
                    }

                    if (typeof loadMedicalCertificates === 'function') {
                        try {
                            loadMedicalCertificates(studentId);
                        } catch (e) {
                            console.warn('–§—É–Ω–∫—Ü–∏—è loadMedicalCertificates –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                        }
                    }

                    if (typeof loadAwards === 'function') {
                        try {
                            loadAwards(studentId);
                        } catch (e) {
                            console.warn('–§—É–Ω–∫—Ü–∏—è loadAwards –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞:', e);
                        }
                    }
                }, 100);

                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');

            })
            .catch(error => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞', 'danger');
            });
    }

    function showMessage(text, type) {
        const messageDiv = document.getElementById('message');
        if (messageDiv) {
            messageDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${text}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
    }
</script>