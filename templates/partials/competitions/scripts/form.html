<!-- templates/partials/competitions/scripts/form.html -->
<script>
    function renderCertificatesList() {
        const certificatesList = $('#certificatesList');
        certificatesList.empty();

        allMedCertificates.forEach(cert => {
            const isSelected = selectedCertificates.includes(cert.id);
            const certElement = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${cert.id}"
                           id="cert_${cert.id}" ${isSelected ? 'checked' : ''}
                           onchange="toggleCertificate(${cert.id})">
                    <label class="form-check-label" for="cert_${cert.id}">
                        ${cert.name}
                    </label>
                </div>
            `;
            certificatesList.append(certElement);
        });
    }

    function toggleCertificate(certId) {
        const index = selectedCertificates.indexOf(certId);
        if (index > -1) {
            selectedCertificates.splice(index, 1);
        } else {
            selectedCertificates.push(certId);
        }
    }

    function searchStudent() {
        const searchTerm = $('#studentSearch').val().toLowerCase();
        if (!searchTerm) return;

        const filteredStudents = allStudents.filter(student =>
            student.name.toLowerCase().includes(searchTerm)
        );

        if (filteredStudents.length > 0) {
            const student = filteredStudents[0];
            if (!selectedStudents.includes(student.id)) {
                selectedStudents.push(student.id);
                renderStudentsList();
            }
            $('#studentSearch').val('');
        }
    }

    function addTrainer() {
        const trainerId = $('#trainerSelect').val();
        if (trainerId && !selectedTrainers.includes(parseInt(trainerId))) {
            selectedTrainers.push(parseInt(trainerId));
            renderTrainersList();
            $('#trainerSelect').val('');
        }
    }

    function renderStudentsList() {
        const studentsList = $('#studentsList');
        studentsList.empty();

        selectedStudents.forEach(studentId => {
            const student = allStudents.find(s => s.id === studentId);
            if (student) {
                const studentElement = `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <span>${student.name}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStudent(${studentId})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                studentsList.append(studentElement);
            }
        });
    }

    function renderTrainersList() {
        const trainersList = $('#trainersList');
        trainersList.empty();

        selectedTrainers.forEach(trainerId => {
            const trainer = allTrainers.find(t => t.id === trainerId);
            if (trainer) {
                const trainerElement = `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <span>${trainer.name}</span>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTrainer(${trainerId})">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                trainersList.append(trainerElement);
            }
        });
    }

    function removeStudent(studentId) {
        selectedStudents = selectedStudents.filter(id => id !== studentId);
        renderStudentsList();
    }

    function removeTrainer(trainerId) {
        selectedTrainers = selectedTrainers.filter(id => id !== trainerId);
        renderTrainersList();
    }

    function showCompetitionForm() {
        $('#dayModal').modal('hide');
        resetCompetitionForm();
        $('#competitionDate').val(currentSelectedDate);
        $('#competitionDateDisplay').val(formatDisplayDate(currentSelectedDate));
        $('#competitionFormTitle').text('–°–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
        $('#deleteCompetitionBtn').hide();
        $('#sendInvitationsBtn').hide(); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
        $('#competitionFormModal').modal('show');
    }

    function editCompetition(competitionId) {
        $('#dayModal').modal('hide');

        $.get(`/competitions/get-competition-data/${competitionId}`, function(data) {
            $('#competitionId').val(data.competition.id);
            $('#competitionName').val(data.competition.name);
            $('#competitionAddress').val(data.competition.address || '');
            $('#competitionDate').val(data.competition.date ? data.competition.date.split('T')[0] : '');
            $('#competitionDateDisplay').val(formatDisplayDate(data.competition.date ? data.competition.date.split('T')[0] : ''));

            selectedStudents = data.students || [];
            selectedTrainers = data.trainers || [];
            selectedCertificates = data.certificates || [];

            renderStudentsList();
            renderTrainersList();
            renderCertificatesList();

            $('#competitionFormTitle').text('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
            $('#deleteCompetitionBtn').show();
            $('#competitionFormModal').modal('show');

        }).fail(function() {
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', 'danger');
        });
    }

    function resetCompetitionForm() {
        $('#competitionForm')[0].reset();
        $('#competitionId').val('');
        selectedStudents = [];
        selectedTrainers = [];
        selectedCertificates = [];
        renderStudentsList();
        renderTrainersList();
        renderCertificatesList();
        $('#sendInvitationsBtn').hide(); // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
    }

    function saveCompetition() {
        const competitionId = $('#competitionId').val();
        const formData = new FormData();

        formData.append('name', $('#competitionName').val());
        formData.append('address', $('#competitionAddress').val());
        formData.append('date', $('#competitionDate').val());

        selectedStudents.forEach(id => formData.append('student_ids', id));
        selectedTrainers.forEach(id => formData.append('trainer_ids', id));
        selectedCertificates.forEach(id => formData.append('certificate_ids', id));

        const url = competitionId ? `/competitions/update-competition/${competitionId}` : '/competitions/create-competition';

        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showMessage(data.message, 'success');
                $('#competitionFormModal').modal('hide');

                if (competitionId) {
                    delete competitionParticipants[competitionId];
                }

                loadEventsForMonth(currentYear, currentMonth + 1);
            } else {
                showMessage(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'danger');
            }
        })
        .catch(error => {
            showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error, 'danger');
        });
    }

    function deleteCompetition() {
        const competitionId = $('#competitionId').val();
        if (!competitionId) return;

        if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?')) {
            fetch(`/competitions/delete-competition/${competitionId}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showMessage(data.message, 'success');
                    $('#competitionFormModal').modal('hide');
                    loadEventsForMonth(currentYear, currentMonth + 1);
                } else {
                    showMessage(data.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'danger');
                }
            })
            .catch(error => {
                showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error, 'danger');
            });
        }
    }

    function sendInvitations() {
        const competitionId = $('#competitionId').val();
        if (!competitionId) {
            showMessage('–û—à–∏–±–∫–∞: –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'danger');
            return;
        }

        if (selectedStudents.length === 0) {
            showMessage('–ù–µ –≤—ã–±—Ä–∞–Ω—ã —É—á–µ–Ω–∏–∫–∏ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π', 'warning');
            return;
        }

        // –°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
        saveCompetitionForInvitations(competitionId);
    }

function saveCompetitionForInvitations(competitionId) {
    const formData = new FormData();

    formData.append('name', $('#competitionName').val());
    formData.append('address', $('#competitionAddress').val());
    formData.append('date', $('#competitionDate').val());

    selectedStudents.forEach(id => formData.append('student_ids', id));
    selectedTrainers.forEach(id => formData.append('trainer_ids', id));
    selectedCertificates.forEach(id => formData.append('certificate_ids', id));

    // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ
    fetch(`/competitions/update-competition/${competitionId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
            sendInvitationsToServer(competitionId);
        } else {
            showMessage(data.message || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'danger');
        }
    })
    .catch(error => {
        showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error, 'danger');
    });
}
function sendInvitationsToServer(competitionId) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const sendBtn = $('#sendInvitationsBtn');
    const originalText = sendBtn.html();
    sendBtn.html('<i class="fas fa-spinner fa-spin me-1"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...');
    sendBtn.prop('disabled', true);

    fetch(`/competitions/send-invitations/${competitionId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        sendBtn.html(originalText);
        sendBtn.prop('disabled', false);

        if (data.status === 'success') {
            showMessage(data.message, 'success');
            console.log('‚úÖ –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:');
            console.log('   –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:', data.details.competition_name);
            console.log('   –í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:', data.details.total_students);
            console.log('   –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö:', data.details.sent_count);
            console.log('   –£–∂–µ –æ—Ç–≤–µ—Ç–∏–ª–∏:', data.details.already_answered_count);
            console.log('   –£–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', data.details.already_sent_count);
            console.log('   –î–µ—Ç–∞–ª–∏:', data.details.student_details);

            // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –Ω–∞ –∫–Ω–æ–ø–∫–µ –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏
            if (data.details.already_answered_count > 0) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å —É–∂–µ –æ—Ç–≤–µ—Ç–∏–≤—à–∏–µ, –ø–æ–∫–∞–∂–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                setTimeout(() => {
                    showMessage(`–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${data.details.already_answered_count} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ`, 'info');
                }, 1000);
            }
        } else if (data.status === 'warning') {
            showMessage(data.message, 'warning');
        } else {
            showMessage(data.message || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π', 'danger');
        }
    })
    .catch(error => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        sendBtn.html(originalText);
        sendBtn.prop('disabled', false);

        showMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error, 'danger');
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:', error);
    });
}


// –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
function checkInvitationsStatus(competitionId) {
    fetch(`/competitions/get-invitations-status/${competitionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:');
                console.log('   –ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', data.status_counts.not_processed);
                console.log('   –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', data.status_counts.sent);
                console.log('   –ü—Ä–∏–Ω—è—Ç–æ:', data.status_counts.accepted);
                console.log('   –û—Ç–∫–ª–æ–Ω–µ–Ω–æ:', data.status_counts.declined);

                // –ú–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
                const sendBtn = $('#sendInvitationsBtn');
                if (data.status_counts.accepted > 0 || data.status_counts.declined > 0) {
                    // –ï—Å—Ç—å —É–∂–µ –æ—Ç–≤–µ—Ç–∏–≤—à–∏–µ
                    sendBtn.html('<i class="fas fa-paper-plane me-1"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–º');
                    sendBtn.attr('title', `–ï—Å—Ç—å ${data.status_counts.accepted + data.status_counts.declined} –æ—Ç–≤–µ—Ç–∏–≤—à–∏—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤`);
                }
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
        });
}


function editCompetition(competitionId) {
    $('#dayModal').modal('hide');

    $.get(`/competitions/get-competition-data/${competitionId}`, function(data) {
        $('#competitionId').val(data.competition.id);
        $('#competitionName').val(data.competition.name);
        $('#competitionAddress').val(data.competition.address || '');
        $('#competitionDate').val(data.competition.date ? data.competition.date.split('T')[0] : '');
        $('#competitionDateDisplay').val(formatDisplayDate(data.competition.date ? data.competition.date.split('T')[0] : ''));

        selectedStudents = data.students || [];
        selectedTrainers = data.trainers || [];
        selectedCertificates = data.certificates || [];

        renderStudentsList();
        renderTrainersList();
        renderCertificatesList();

        $('#competitionFormTitle').text('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è');
        $('#deleteCompetitionBtn').show();
        $('#sendInvitationsBtn').show();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π
        checkInvitationsStatus(competitionId);

        $('#competitionFormModal').modal('show');

    }).fail(function() {
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', 'danger');
    });
}

</script>