<!-- templates/edit_students.html -->
{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤{% endblock %}

{% block content %}
<h1>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤</h1>

<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">–í—ã–±–æ—Ä —É—á–µ–Ω–∏–∫–∞</h5>
    </div>
    <div class="card-body">
        <div class="row">
    <div class="col-md-6">
        <label for="studentSelect" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞:</label>
                <select id="studentSelect" class="form-select" required>
                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–∞ --</option>
                    {% for student in students %}
                    <option value="{{ student.id }}">{{ student.name }}</option>
                    {% endfor %}
                </select>
                <div class="form-text">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è –¥–ª—è –ø–æ–∏—Å–∫–∞</div>
            </div>
            <div class="col-md-6 d-flex align-items-center">
                <button type="button" class="btn btn-primary" onclick="createNewStudent()">
                    <i class="fas fa-plus"></i>
                    –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
                </button>
            </div>
        </div>
    </div>
</div>

<div id="studentCard" class="student-card hidden">
    <h3>–ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ–Ω–∏–∫–∞</h3>
    <form id="studentForm">
        <input type="hidden" id="studentId" name="student_id">

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="form-section">
            <h5 class="section-title">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="name" class="form-label">–§–ò–û —É—á–µ–Ω–∏–∫–∞ *</label>
                    <input type="text" class="form-control" id="name" name="name" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="birthday" class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                    <input type="date" class="form-control" id="birthday" name="birthday">
                </div>
                <div class="col-md-12 mb-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="active" name="active" checked>
                        <label class="form-check-label" for="active">
                            –ê–∫—Ç–∏–≤–Ω—ã–π —É—á–µ–Ω–∏–∫
                        </label>
                    </div>
                    <div class="form-text">–ï—Å–ª–∏ —Å–Ω—è—Ç—å –≥–∞–ª–æ—á–∫—É, —É—á–µ–Ω–∏–∫ –±—É–¥–µ—Ç —Å–∫—Ä—ã—Ç –∏–∑ —Å–ø–∏—Å–∫–æ–≤</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="sport_discipline" class="form-label">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞</label>
                    <select class="form-select" id="sport_discipline" name="sport_discipline">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É --</option>
                        {% for sport in sports %}
                        <option value="{{ sport.id }}">{{ sport.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="rang" class="form-label">–¶–≤–µ—Ç –ø–æ—è—Å–∞</label>
                    <select class="form-select" id="rang" name="rang">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –ø–æ—è—Å–∞ --</option>
                        {% for belt in belt_colors %}
                        <option value="{{ belt.id }}">{{ belt.name }} ({{ belt.color }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="sports_rank" class="form-label">–†–∞–∑—Ä—è–¥/–∑–≤–∞–Ω–∏–µ</label>
                    <select class="form-select" id="sports_rank" name="sports_rank">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑—Ä—è–¥ --</option>
                        {% for rank in sports_ranks %}
                        <option value="{{ rank.id }}">{{ rank.rank }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="weight" class="form-label">–í–µ—Å (–∫–≥)</label>
                    <input type="number" class="form-control" id="weight" name="weight" min="0">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="telephone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="tel" class="form-control" id="telephone" name="telephone">
                </div>
            </div>
        </div>

        <!-- –¢—Ä–µ–Ω–µ—Ä—ã -->
        <div class="form-section">
            <h5 class="section-title">–¢—Ä–µ–Ω–µ—Ä—ã</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="head_trainer_id" class="form-label">–ì–ª–∞–≤–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä</label>
                    <select class="form-select" id="head_trainer_id" name="head_trainer_id">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞ --</option>
                        {% for trainer in trainers %}
                        <option value="{{ trainer.id }}">{{ trainer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="second_trainer_id" class="form-label">–í—Ç–æ—Ä–æ–π —Ç—Ä–µ–Ω–µ—Ä</label>
                    <select class="form-select" id="second_trainer_id" name="second_trainer_id">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–Ω–µ—Ä–∞ --</option>
                        {% for trainer in trainers %}
                        <option value="{{ trainer.id }}">{{ trainer.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- –û–ø–ª–∞—Ç–∞ -->
        <div class="form-section">
            <h5 class="section-title">–û–ø–ª–∞—Ç–∞ –∏ –∑–∞–Ω—è—Ç–∏—è</h5>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="price" class="form-label">–¢–∞—Ä–∏—Ñ</label>
                    <select class="form-select" id="price" name="price">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ --</option>
                        {% for price in prices %}
                        <option value="{{ price.id }}"
                                data-price-amount="{{ price.price }}"
                                data-classes-count="{{ price.classes_in_price or 0 }}">
                            {% if price.description %}
                                {{ price.description }} - {{ price.price }} —Ä—É–±.
                            {% else %}
                                –¢–∞—Ä–∏—Ñ {{ price.id }} - {{ price.price }} —Ä—É–±.
                            {% endif %}
                            {% if price.classes_in_price %}
                                ({{ price.classes_in_price }} –∑–∞–Ω—è—Ç–∏–π)
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="form-text" id="priceInfo"></div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="payment_day" class="form-label">–î–µ–Ω—å –æ–ø–ª–∞—Ç—ã</label>
                    <input type="number" class="form-control" id="payment_day" name="payment_day" min="1" max="31">
                </div>
                <div class="col-md-4 mb-3">
                    <label for="classes_remaining" class="form-label">–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–Ω—è—Ç–∏–π</label>
                    <input type="number" class="form-control" id="classes_remaining" name="classes_remaining" min="0">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="expected_payment_date" class="form-label">–û–∂–∏–¥–∞–µ–º–∞—è –¥–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</label>
                    <input type="date" class="form-control" id="expected_payment_date" name="expected_payment_date">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="date_start" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</label>
                    <input type="datetime-local" class="form-control" id="date_start" name="date_start">
                </div>
            </div>
        </div>

        <!-- –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–ø—Ä–∞–≤–∫–∏ -->
        <div class="form-section">
            <h5 class="section-title">–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–ø—Ä–∞–≤–∫–∏</h5>

            <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–ø—Ä–∞–≤–æ–∫ -->
            <div id="certificatesList" class="mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">–¢–µ–∫—É—â–∏–µ —Å–ø—Ä–∞–≤–∫–∏</h6>
                    <button type="button" class="btn btn-sm btn-success" onclick="showAddCertificateForm()">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É
                    </button>
                </div>
                <div id="certificatesContainer">
                    <!-- –°–ø—Ä–∞–≤–∫–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
                </div>
            </div>

            <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏ -->
            <div id="certificateFormContainer" class="hidden">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0" id="certificateFormTitle">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏</h6>
                    </div>
                    <div class="card-body">
                        <form id="certificateForm">
                            <input type="hidden" id="certificateId" name="certificate_id">
                            <input type="hidden" id="certificateStudentId" name="student_id">

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="cert_id" class="form-label">–¢–∏–ø —Å–ø—Ä–∞–≤–∫–∏ *</label>
                                    <select class="form-select" id="cert_id" name="cert_id" required>
                                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–ø—Ä–∞–≤–∫–∏ --</option>
                                        <!-- –¢–∏–ø—ã —Å–ø—Ä–∞–≤–æ–∫ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                                    </select>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="cert_date_start" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ *</label>
                                    <input type="date" class="form-control" id="cert_date_start" name="date_start" required>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="cert_date_end" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è *</label>
                                    <input type="date" class="form-control" id="cert_date_end" name="date_end" required>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="cert_active" name="active" checked>
                                        <label class="form-check-label" for="cert_active">
                                            –°–ø—Ä–∞–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø—Ä–∞–≤–∫—É
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="hideCertificateForm()">
                                    –û—Ç–º–µ–Ω–∞
                                </button>
                                <button type="button" id="deleteCertificateBtn" class="btn btn-danger ms-auto hidden"
                                        onclick="deleteCertificate()">
                                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ -->
        <div class="form-section">
            <h5 class="section-title">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="telegram_id" class="form-label">Telegram ID</label>
                    <input type="number" class="form-control" id="telegram_id" name="telegram_id">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="parent1" class="form-label">–†–æ–¥–∏—Ç–µ–ª—å 1 ID</label>
                    <input type="number" class="form-control" id="parent1" name="parent1">
                </div>
                <div class="col-md-3 mb-3">
                    <label for="parent2" class="form-label">–†–æ–¥–∏—Ç–µ–ª—å 2 ID</label>
                    <input type="number" class="form-control" id="parent2" name="parent2">
                </div>
            </div>
        </div>

     <button type="submit" class="btn btn-primary btn-lg">
    <i class="fas fa-save"></i>
    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
</button>
<a href="/" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é</a>
    </form>
</div>

<div id="message" class="mt-3"></div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Select2 –¥–ª—è –ø–æ–∏—Å–∫–∞ —É—á–µ–Ω–∏–∫–æ–≤
        $('#studentSelect').select2({
            language: "ru",
            placeholder: "–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∏–º—è —É—á–µ–Ω–∏–∫–∞",
            allowClear: true
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
        $('#studentSelect').change(function() {
            const studentId = $(this).val();
            if (studentId) {
                loadStudentData(studentId);
                $('#studentCard').removeClass('hidden');
                $('#studentCard h3').text('–ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ–Ω–∏–∫–∞');
                $('#studentForm button[type="submit"]').html('<i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
            } else {
                $('#studentCard').addClass('hidden');
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —É—á–µ–Ω–∏–∫–∞
        $('#studentForm').submit(function(e) {
            e.preventDefault();
            updateStudent();
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Å–ø—Ä–∞–≤–∫–∏
        $('#certificateForm').submit(function(e) {
            e.preventDefault();
            console.log('üîÑ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —Å–ø—Ä–∞–≤–∫–∏');

            const formData = new FormData(this);
            const certificateId = $('#certificateId').val();

            const url = certificateId ? '/edit-students/update-medical-certificate' : '/edit-students/add-medical-certificate';

            fetch(url, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                showMessage(data.message, 'success');
                hideCertificateForm();
                loadMedicalCertificates($('#studentId').val());
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏: ' + error.message, 'danger');
            });
        });
    });

    // ================== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –£–ß–ï–ù–ò–ö–ê ==================

    function loadStudentData(studentId) {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞ ID:', studentId);

        $.get(`/edit-students/get-student-data/${studentId}`, function(student) {
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞:', student);

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —É—á–µ–Ω–∏–∫–∞
            $('#studentId').val(student.id);
            $('#name').val(student.name || '');
            $('#birthday').val(student.birthday ? student.birthday.split('T')[0] : '');
            $('#sport_discipline').val(student.sport_discipline || '');
            $('#rang').val(student.rang || '');  // –¢–µ–ø–µ—Ä—å —ç—Ç–æ ID —Ü–≤–µ—Ç–∞ –ø–æ—è—Å–∞
            $('#sports_rank').val(student.sports_rank || '');
            $('#sex').val(student.sex || '');
            $('#weight').val(student.weight || '');
            $('#telephone').val(student.telephone || '');
            $('#head_trainer_id').val(student.head_trainer_id || '');
            $('#second_trainer_id').val(student.second_trainer_id || '');
            $('#price').val(student.price || '');
            $('#payment_day').val(student.payment_day || '');
            $('#classes_remaining').val(student.classes_remaining || '');
            $('#expected_payment_date').val(student.expected_payment_date ? student.expected_payment_date.split('T')[0] : '');
            $('#parent1').val(student.parent1 || '');
            $('#parent2').val(student.parent2 || '');
            $('#date_start').val(student.date_start ? student.date_start.replace('Z', '').substring(0, 16) : '');
            $('#telegram_id').val(student.telegram_id || '');
            $('#active').prop('checked', student.active !== false);

            console.log('rang (belt color ID):', student.rang);
            console.log('sports_rank:', student.sports_rank);

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ç–∞—Ä–∏—Ñ–µ
            if (student.price) {
                const selectedOption = $('#price').find(`option[value="${student.price}"]`);
                if (selectedOption.length) {
                    const priceAmount = selectedOption.data('price-amount');
                    const classesCount = selectedOption.data('classes-count');

                    let infoText = '';
                    if (priceAmount) {
                        infoText += `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceAmount} —Ä—É–±. `;
                    }
                    if (classesCount) {
                        infoText += `–ó–∞–Ω—è—Ç–∏–π –≤ —Ç–∞—Ä–∏—Ñ–µ: ${classesCount}`;
                    }

                    $('#priceInfo').text(infoText);
                }
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–ø—Ä–∞–≤–∫–∏ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            loadMedicalCertificates(studentId);

        }).fail(function(xhr, status, error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —É—á–µ–Ω–∏–∫–∞: ' + error, 'danger');
        });
    }

    function updateStudent() {
        const formData = new FormData(document.getElementById('studentForm'));
        const studentId = $('#studentId').val();

        console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö:', Object.fromEntries(formData));
        console.log('Student ID:', studentId);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –∏ –º–µ—Ç–æ–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, –Ω–æ–≤—ã–π —ç—Ç–æ —É—á–µ–Ω–∏–∫ –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
        const url = studentId === 'new' ? '/edit-students/create-student' : '/edit-students/update-student';
        const method = 'POST';

        fetch(url, {
            method: method,
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            showMessage(data.message, 'success');

            if (studentId === 'new') {
                // –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
                $('#studentId').val(data.student_id); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π ID
                $('#studentCard h3').text('–ö–∞—Ä—Ç–æ—á–∫–∞ —É—á–µ–Ω–∏–∫–∞');
                $('#studentForm button[type="submit"]').text('–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');

                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                const newStudentName = $('#name').val();
                const newStudentId = data.student_id;
                $('#studentSelect').append(new Option(newStudentName, newStudentId));
                $('#studentSelect').val(newStudentId).trigger('change');
            } else {
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–º—è –≤ –≤—ã–ø–∞–¥–∞—é—â–µ–º —Å–ø–∏—Å–∫–µ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —É—á–µ–Ω–∏–∫–∞
                const studentSelect = $('#studentSelect');
                const currentStudentId = $('#studentId').val();
                const currentStudentName = $('#name').val();
                studentSelect.find(`option[value="${currentStudentId}"]`).text(currentStudentName);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message, 'danger');
        });
    }

    function showMessage(text, type) {
        $('#message').html(`
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${text}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);

        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–∞
    $('#price').change(function() {
        const selectedOption = $(this).find('option:selected');
        const priceAmount = selectedOption.data('price-amount');
        const classesCount = selectedOption.data('classes-count');

        let infoText = '';
        if (priceAmount) {
            infoText += `–°—Ç–æ–∏–º–æ—Å—Ç—å: ${priceAmount} —Ä—É–±. `;
        }
        if (classesCount) {
            infoText += `–ó–∞–Ω—è—Ç–∏–π –≤ —Ç–∞—Ä–∏—Ñ–µ: ${classesCount}`;
        }

        $('#priceInfo').text(infoText);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–∏–π –µ—Å–ª–∏ –ø–æ–ª–µ –ø—É—Å—Ç–æ–µ
        if (classesCount && !$('#classes_remaining').val()) {
            $('#classes_remaining').val(classesCount);
        }
    });

    function createNewStudent() {
        // –°–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ç–µ–∫—É—â–µ–≥–æ —É—á–µ–Ω–∏–∫–∞
        $('#studentCard').addClass('hidden');

        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        $('#studentForm')[0].reset();

        // –£–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –∏–∑ select
        $('#studentSelect').val('').trigger('change');

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ –ø–æ–ª–µ "–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫"
        const now = new Date();
        const localDateTime = now.toISOString().slice(0, 16);
        $('#date_start').val(localDateTime);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Å—Ç–∞—Ç—É—Å (–≥–∞–ª–æ—á–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞)
        $('#active').prop('checked', true);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
        $('#studentId').val('new');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –ø—É—Å—Ç–æ–π —Ñ–æ—Ä–º–æ–π
        $('#studentCard').removeClass('hidden');

        // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        $('#studentCard h3').text('–ù–æ–≤—ã–π —É—á–µ–Ω–∏–∫');

        // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        $('#studentForm button[type="submit"]').html('<i class="fas fa-user-plus"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É');

        // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø—Ä–∞–≤–∫–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
        $('#certificatesContainer').html('<div class="text-muted">–°–ø—Ä–∞–≤–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞</div>');
        $('#certificateFormContainer').addClass('hidden');

        showMessage('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞', 'info');
    }

    // ================== –ú–ï–î–ò–¶–ò–ù–°–ö–ò–ï –°–ü–†–ê–í–ö–ò ==================

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–ø—Ä–∞–≤–æ–∫
    function loadMedicalCertificates(studentId) {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–ø—Ä–∞–≤–æ–∫ –¥–ª—è —É—á–µ–Ω–∏–∫–∞:', studentId);

        if (!studentId || studentId === 'new') {
            $('#certificatesContainer').html('<div class="text-muted">–°–ø—Ä–∞–≤–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞</div>');
            return;
        }

        $.get(`/edit-students/get-medical-certificates/${studentId}`, function(certificates) {
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ —Å–ø—Ä–∞–≤–∫–∏:', certificates);

            if (certificates.length === 0) {
                $('#certificatesContainer').html('<div class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–ø—Ä–∞–≤–æ–∫</div>');
                return;
            }

            let html = '';
            certificates.forEach(cert => {
                const startDate = cert.date_start ? new Date(cert.date_start).toLocaleDateString('ru-RU') : '‚Äî';
                const endDate = cert.date_end ? new Date(cert.date_end).toLocaleDateString('ru-RU') : '‚Äî';
                const isExpired = cert.date_end ? new Date(cert.date_end) < new Date() : false;
                const statusClass = isExpired ? 'text-danger' : (cert.active ? 'text-success' : 'text-muted');
                const statusText = isExpired ? '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞' : (cert.active ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞');

                html += `
                    <div class="card mb-2 ${isExpired ? 'border-danger' : ''}">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <strong>${cert.cert_name}</strong>
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">–ù–∞—á–∞–ª–æ:</small><br>
                                    ${startDate}
                                </div>
                                <div class="col-md-2">
                                    <small class="text-muted">–û–∫–æ–Ω—á–∞–Ω–∏–µ:</small><br>
                                    ${endDate}
                                </div>
                                <div class="col-md-2">
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                            onclick="editCertificate(${cert.id}, ${cert.cert_id}, '${cert.date_start}', '${cert.date_end}', ${cert.active})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            $('#certificatesContainer').html(html);
        }).fail(function(xhr, status, error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ–∫:', error);
            $('#certificatesContainer').html('<div class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ–∫</div>');
        });
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏
    function showAddCertificateForm() {
        console.log('üîÑ –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏');

        const studentId = $('#studentId').val();
        console.log('Student ID:', studentId);

        if (!studentId || studentId === 'new') {
            showMessage('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞', 'warning');
            return;
        }

        $('#certificateFormTitle').text('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏');
        $('#certificateId').val('');
        $('#certificateStudentId').val(studentId);
        $('#certificateForm')[0].reset();
        $('#cert_active').prop('checked', true);
        $('#deleteCertificateBtn').addClass('hidden');
        $('#certificateFormContainer').removeClass('hidden');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∏–ø—ã —Å–ø—Ä–∞–≤–æ–∫ –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        loadCertificateTypes();
    }

    // –°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Å–ø—Ä–∞–≤–∫–∏
    function hideCertificateForm() {
        $('#certificateFormContainer').addClass('hidden');
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏
    function editCertificate(certificateId, certId, dateStart, dateEnd, active) {
        console.log('üîÑ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏:', certificateId);

        $('#certificateFormTitle').text('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏');
        $('#certificateId').val(certificateId);
        $('#certificateStudentId').val($('#studentId').val());
        $('#cert_id').val(certId);
        $('#cert_date_start').val(dateStart ? dateStart.split('T')[0] : '');
        $('#cert_date_end').val(dateEnd ? dateEnd.split('T')[0] : '');
        $('#cert_active').prop('checked', active);
        $('#deleteCertificateBtn').removeClass('hidden');
        $('#certificateFormContainer').removeClass('hidden');

        loadCertificateTypes();
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ —Å–ø—Ä–∞–≤–æ–∫
    function loadCertificateTypes() {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–ø–æ–≤ —Å–ø—Ä–∞–≤–æ–∫');

        if ($('#cert_id option').length > 1) {
            console.log('–¢–∏–ø—ã —Å–ø—Ä–∞–≤–æ–∫ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            return; // –£–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        }

        $.get('/edit-students/get-certificate-types', function(types) {
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã —Ç–∏–ø—ã —Å–ø—Ä–∞–≤–æ–∫:', types);

            let options = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–ø—Ä–∞–≤–∫–∏ --</option>';
            types.forEach(type => {
                options += `<option value="${type.id}">${type.name}</option>`;
            });
            $('#cert_id').html(options);
        }).fail(function(xhr, status, error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —Å–ø—Ä–∞–≤–æ–∫:', error);
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ —Å–ø—Ä–∞–≤–æ–∫', 'danger');
        });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ —Å–ø—Ä–∞–≤–∫–∏
    function deleteCertificate() {
        const certificateId = $('#certificateId').val();
        if (!certificateId) return;

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É?')) {
            return;
        }

        $.ajax({
            url: `/edit-students/delete-medical-certificate/${certificateId}`,
            type: 'DELETE',
            success: function(response) {
                showMessage(response.message, 'success');
                hideCertificateForm();
                loadMedicalCertificates($('#studentId').val());
            },
            error: function(xhr, status, error) {
                showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏: ' + error, 'danger');
            }
        });
    }
</script>
