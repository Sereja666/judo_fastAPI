<!-- templates/partials/edit_students/awards_js.html -->
<script>
    // ================== –ù–ê–ì–†–ê–î–´ –ò –î–û–°–¢–ò–ñ–ï–ù–ò–Ø ==================

    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–≥—Ä–∞–¥
    function loadAwards(studentId) {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–≥—Ä–∞–¥ –¥–ª—è —É—á–µ–Ω–∏–∫–∞:', studentId);

        if (!studentId || studentId === 'new') {
            $('#awardsContainer').html('<div class="text-muted">–ù–∞–≥—Ä–∞–¥—ã –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—á–µ–Ω–∏–∫–∞</div>');
            return;
        }

        $.get(`/edit-students/get-awards/${studentId}`, function(awards) {
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –Ω–∞–≥—Ä–∞–¥—ã:', awards);

            if (awards.length === 0) {
                $('#awardsContainer').html('<div class="text-muted">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è—Ö</div>');
                return;
            }

            let html = '';
            awards.forEach(award => {
                const competitionDate = award.competition_date ? new Date(award.competition_date).toLocaleDateString('ru-RU') : '‚Äî';
                const statusText = getStatusText(award.status_id);
                const statusClass = getStatusClass(award.status_id);

                html += `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <strong>${award.competition_name}</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">–î–∞—Ç–∞:</small><br>
                                    ${competitionDate}
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç:</small><br>
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                            onclick="editAward(${award.id}, ${award.competition_id}, ${award.status_id})">
                                        <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            $('#awardsContainer').html(html);
        }).fail(function(xhr, status, error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≥—Ä–∞–¥:', error);
            $('#awardsContainer').html('<div class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–≥—Ä–∞–¥</div>');
        });
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
    function getStatusText(statusId) {
        const statusMap = {
            0: '–û–∂–∏–¥–∞–Ω–∏–µ/–£—á–∞—Å—Ç–∏–µ',
            1: '1 –º–µ—Å—Ç–æ',
            2: '2 –º–µ—Å—Ç–æ',
            3: '3 –º–µ—Å—Ç–æ',
            4: '4 –º–µ—Å—Ç–æ',
            5: '5 –º–µ—Å—Ç–æ',
            98: '–ü—Ä–æ–ø—É—Å–∫',
            99: '–ü—Ä–æ–∏–≥—Ä–∞–ª'
        };
        return statusMap[statusId] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏
    function getStatusClass(statusId) {
        if ([1, 2, 3].includes(parseInt(statusId))) {
            return 'bg-success text-white';
        } else if (statusId == 0) {
            return 'bg-warning text-dark';
        } else if (statusId == 98) {
            return 'bg-info text-white';
        } else if (statusId == 99) {
            return 'bg-danger text-white';
        } else {
            return 'bg-secondary text-white';
        }
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã
    function showAddAwardForm() {
        console.log('üîÑ –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã');

        const studentId = $('#studentId').val();
        console.log('Student ID:', studentId);

        if (!studentId || studentId === 'new') {
            showMessage('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —É—á–µ–Ω–∏–∫–∞', 'warning');
            return;
        }

        $('#awardModalLabel').text('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è');
        $('#awardId').val('');
        $('#awardStudentId').val(studentId);
        $('#awardForm')[0].reset();
        $('#competition_id').prop('disabled', false);
        $('#deleteAwardBtn').addClass('hidden');

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
        loadCompetitions().then(() => {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = new bootstrap.Modal(document.getElementById('awardModal'));
            modal.show();
        });
    }

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã
    function editAward(awardId, competitionId, statusId) {
        console.log('üîÑ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã:', awardId);

        $('#awardModalLabel').text('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è');
        $('#awardId').val(awardId);
        $('#awardStudentId').val($('#studentId').val());

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ
        loadCompetitions().then(() => {
            $('#competition_id').val(competitionId);
            $('#competition_id').prop('disabled', true); // –ó–∞–ø—Ä–µ—â–∞–µ–º –∏–∑–º–µ–Ω—è—Ç—å —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
            $('#status_id').val(statusId);
            $('#deleteAwardBtn').removeClass('hidden');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = new bootstrap.Modal(document.getElementById('awardModal'));
            modal.show();
        });
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã
    function saveAward() {
        console.log('üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã');

        const formData = new FormData(document.getElementById('awardForm'));
        const awardId = $('#awardId').val();

        // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }

        const url = awardId ? '/edit-students/update-award' : '/edit-students/add-award';

        fetch(url, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                });
            }
            return response.json();
        })
        .then(data => {
            showMessage(data.message, 'success');

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('awardModal'));
            modal.hide();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥
            loadAwards($('#studentId').val());
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showMessage('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ' + error.message, 'danger');
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π
    function loadCompetitions() {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π');

        return new Promise((resolve, reject) => {
            if ($('#competition_id option').length > 1) {
                console.log('–°–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                resolve();
                return;
            }

            $.get('/edit-students/get-competitions', function(competitions) {
                console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è:', competitions);

                let options = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–µ --</option>';
                competitions.forEach(comp => {
                    const dateStr = comp.date ? new Date(comp.date).toLocaleDateString('ru-RU') : '';
                    options += `<option value="${comp.id}">${comp.name} (${dateStr})</option>`;
                });
                $('#competition_id').html(options);
                resolve();
            }).fail(function(xhr, status, error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π:', error);
                showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–π', 'danger');
                reject(error);
            });
        });
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä–∞–¥—ã
    function deleteAward() {
        const awardId = $('#awardId').val();
        if (!awardId) return;

        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å –æ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏–∏?')) {
            return;
        }

        $.ajax({
            url: `/edit-students/delete-award/${awardId}`,
            type: 'DELETE',
            success: function(response) {
                showMessage(response.message, 'success');

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('awardModal'));
                modal.hide();

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–≥—Ä–∞–¥
                loadAwards($('#studentId').val());
            },
            error: function(xhr, status, error) {
                showMessage('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏: ' + error, 'danger');
            }
        });
    }
</script>